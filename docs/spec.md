# MedVision MCP v2 æ¶æ§‹è¦æ ¼æ›¸

> ç‰ˆæœ¬: 0.6.1  
> æ—¥æœŸ: 2026-02-02  
> ç‹€æ…‹: Draft

## è®Šæ›´è¨˜éŒ„

| ç‰ˆæœ¬ | æ—¥æœŸ | è®Šæ›´ |
|:-----|:-----|:-----|
| 0.6.1 | 2026-02-02 | ä¿®æ­£ Section 2.3 ç·¨è™Ÿè¡çªï¼›ROADMAP æ”¹å¯«ç‚º Visual RAG Mode B å°å‘ï¼›æ¨¡å‹ä¸‹è¼‰é‡åŠ è¨»æŠ“å–æ—¥æœŸï¼›æ›´æ–°å·²æ±ºå®šäº‹é … |
| 0.6.0 | 2026-02-02 | æ–°å¢ Visual RAG æ··åˆæ¨¡å¼ (Mode B)ï¼šRAD-DINO + FAISS + DenseNetï¼Œ`search_similar_cases`, `analyze_with_rag` ç­‰å·¥å…· |
| 0.5.0 | 2026-02-02 | æ–°å¢äº’å‹•è¨ºæ–·æµç¨‹è¨­è¨ˆã€Canvas æ¨™è¨˜é¡å‹å®šç¾©ã€A2A vs ç´” MCP é›™æ¨¡å¼ã€å·²é©—è­‰æ¨¡å‹ç‹€æ…‹è¡¨ |
| 0.4.0 | 2026-02-02 | æ¶æ§‹é‡æ§‹ï¼šMCP Server + Multi-Model Tools + å…§å»º Medical Agent (A2A)ï¼›æ–°å¢ Canvas ç¹ªç•«å·¥ä½œå€è¦æ ¼ |
| 0.3.1 | 2026-01-28 | æ–°å¢å®Œæ•´ AI æ¨¡å‹æ¸…å–®ï¼šRadiology VLMã€Medical Encodersã€CT Segmentationã€Pathology Foundation Models |
| 0.3.0 | 2026-01-28 | ç¢ºèª Medical-SAM3ã€vLLM lazy loading ç­–ç•¥ã€æ›´æ–°æ¨¡å‹ä¾†æº |
| 0.2.0 | 2026-01-28 | æŠ€è¡“æ±ºç­–ï¼šSQLiteã€vLLM/Ollamaã€SAM3ã€React Canvas |
| 0.1.0 | 2026-01-28 | åˆç‰ˆ |

---

## 1. æ¦‚è¿°

### 1.1 èƒŒæ™¯

MedVision MCP v1 æ˜¯ä¸€å€‹åŸºæ–¼ LangGraph ReAct æ¶æ§‹çš„é†«ç™‚å½±åƒåˆ†æ Agentï¼Œæ•´åˆäº†å¤šå€‹ AI æ¨¡å‹ä½œç‚ºå·¥å…·ã€‚éš¨è‘— AI Agent ç”Ÿæ…‹æ¼”é€²ï¼ˆMCP Protocolã€A2Aã€é•·æ€è€ƒ Agentï¼‰ï¼Œéœ€è¦é‡æ–°è¨­è¨ˆæ¶æ§‹ä»¥æå‡äº’æ“ä½œæ€§å’Œç”¨æˆ¶é«”é©—ã€‚

### 1.2 æ ¸å¿ƒæ¶æ§‹ç†å¿µ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MedVision MCP = MCP Server + Agent                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚   MCP Tools       â”‚     â”‚   MedVision MCP Agent (Optional)     â”‚  â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚     â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€   â”‚  â”‚
â”‚   â”‚   â€¢ VQA           â”‚â—„â”€â”€â”€â”€â”‚   â€¢ ä½¿ç”¨ MCP Tools            â”‚  â”‚
â”‚   â”‚   â€¢ Segmentation  â”‚     â”‚   â€¢ ç†è§£é†«ç™‚å½±åƒèªç¾©          â”‚  â”‚
â”‚   â”‚   â€¢ Classificationâ”‚     â”‚   â€¢ è‡ªå‹•åˆ†ææµç¨‹ç·¨æ’          â”‚  â”‚
â”‚   â”‚   â€¢ Report Gen    â”‚     â”‚   â€¢ èˆ‡ User å°è©±äº’å‹•          â”‚  â”‚
â”‚   â”‚   â€¢ Grounding     â”‚     â”‚   â€¢ A2A å”ä½œèƒ½åŠ›              â”‚  â”‚
â”‚   â”‚   â€¢ ...           â”‚     â”‚                               â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                 â”‚                           â”‚
                 â”‚ MCP Protocol              â”‚ MCP Protocol
                 â–¼                           â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚  External Agents    â”‚     â”‚  Canvas UI (User)       â”‚
    â”‚  (Claude, GPT, etc) â”‚     â”‚  ç¹ªç•«å·¥ä½œå€äº’å‹•          â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¨­è¨ˆå“²å­¸**ï¼š
- MCP Server å°è£å¤šç¨® AI æ¨¡å‹ç‚ºæ¨™æº–åŒ– Tools
- å…§å»º Medical Agent ä½¿ç”¨é€™äº› Toolsï¼ˆA2A-like æ¶æ§‹ï¼‰
- å¤–éƒ¨ Agentï¼ˆå¦‚ Claudeï¼‰ä¹Ÿå¯ç›´æ¥èª¿ç”¨ MCP Tools
- Canvas UI é€é MCP Protocol èˆ‡ Agent/Tools äº’å‹•

### 1.3 è¨­è¨ˆç›®æ¨™

| ç›®æ¨™ | èªªæ˜ |
|:-----|:-----|
| **MCP Server** | æ‰€æœ‰ AI æ¨¡å‹å°è£ç‚º MCP Toolsï¼Œæä¾›æ¨™æº–åŒ–ä»‹é¢ |
| **Multi-Model Tools** | æ•´åˆ VQAã€åˆ†å‰²ã€åˆ†é¡ã€å ±å‘Šç”Ÿæˆç­‰å¤šç¨®æ¨¡å‹ |
| **å…§å»º Agent (A2A)** | æä¾› Medical Agent ä½¿ç”¨é€™äº› Toolsï¼Œæ”¯æ´è‡ªå‹•åŒ–åˆ†ææµç¨‹ |
| **Canvas ç¹ªç•«å·¥ä½œå€** | ç”¨æˆ¶é€éç•«æ¿èˆ‡ Agent äº’å‹•ï¼Œé¸å®šå€åŸŸé€²è¡Œåˆ†æ |
| **é›™å‘ MCP é€šè¨Š** | UI â†” Agent â†” Tools å‡é€é MCP Protocol é‹ä½œ |
| **Session å°å‘** | æ”¯æŒå¤šå½±åƒã€å¤šè¼ªäº’å‹•çš„å®Œæ•´åˆ†ææœƒè©± |
| **å¤šæ¨¡æ…‹æ”¯æŒ** | CXRã€KUBã€EKGã€CTã€MRIã€DICOM |

### 1.4 éç›®æ¨™

- ä¸æä¾›å®Œæ•´çš„ PACS ç³»çµ±åŠŸèƒ½
- ä¸è™•ç† PHI/HIPAA åˆè¦ï¼ˆç”±éƒ¨ç½²æ–¹è² è²¬ï¼‰

---

## 2. æ¶æ§‹

### 2.1 æ•´é«”æ¶æ§‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         External Agent Layer                                â”‚
â”‚                  (Claude / GPT / Custom Agent / CLI)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ MCP Protocol
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          MedVision MCP MCP Server                                  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                    MedVision MCP Medical Agent (Optional)                  â”‚   â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚   â”‚   â€¢ ReAct / Chain-of-Thought æ¨ç†                                   â”‚   â”‚
â”‚   â”‚   â€¢ é†«ç™‚å½±åƒèªç¾©ç†è§£                                                  â”‚   â”‚
â”‚   â”‚   â€¢ è‡ªå‹•ç·¨æ’åˆ†ææµç¨‹ (VQA â†’ Segment â†’ Report)                        â”‚   â”‚
â”‚   â”‚   â€¢ èˆ‡ Canvas UI äº’å‹•                                               â”‚   â”‚
â”‚   â”‚   â€¢ A2A (Agent-to-Agent) å”ä½œä»‹é¢                                   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚ Internal MCP Calls                     â”‚
â”‚                                    â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚   â”‚   Session   â”‚  â”‚  Analysis   â”‚  â”‚ Interactive â”‚  â”‚   Canvas    â”‚       â”‚
â”‚   â”‚  Management â”‚  â”‚   Tools     â”‚  â”‚   Tools     â”‚  â”‚   Tools     â”‚       â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                        â”‚
â”‚   â”‚   Export    â”‚  â”‚   Query     â”‚  â”‚   Agent     â”‚                        â”‚
â”‚   â”‚   Tools     â”‚  â”‚   Tools     â”‚  â”‚   Tools     â”‚                        â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                        â”‚
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     AI Model Registry                               â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚   â”‚
â”‚   â”‚   â”‚CheXagentâ”‚ â”‚LLaVA-Medâ”‚ â”‚ MAIRA-2 â”‚ â”‚Med-SAM3 â”‚ â”‚BiomedCLIPâ”‚     â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚   â”‚
â”‚   â”‚   (vLLM / Ollama / PyTorch å¾Œç«¯çµ±ä¸€ç®¡ç†)                            â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         Session Store (SQLite)                              â”‚
â”‚          (Images, Analyses, Annotations, Interactions, Canvas State)        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                    â”‚ MCP Resources / WebSocket
                                    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Canvas ç¹ªç•«å·¥ä½œå€ (Human UI)                            â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚   Image Viewer + Annotation Canvas                                  â”‚   â”‚
â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚   â”‚
â”‚   â”‚   â€¢ å½±åƒé¡¯ç¤ºèˆ‡ç¸®æ”¾                                                   â”‚   â”‚
â”‚   â”‚   â€¢ ç¹ªåœ–å·¥å…· (BBox, Polygon, Point, Freehand)                       â”‚   â”‚
â”‚   â”‚   â€¢ AI åˆ†å‰²çµæœç–ŠåŠ                                                   â”‚   â”‚
â”‚   â”‚   â€¢ èˆ‡ Agent å°è©±å€                                                 â”‚   â”‚
â”‚   â”‚   â€¢ é€é MCP Protocol å‚³é€ç”¨æˆ¶é¸å®šå€åŸŸçµ¦ Agent                       â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚               (React + Fabric.js / VS Code Extension / Web)                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.2 çµ„ä»¶èªªæ˜

| çµ„ä»¶ | è·è²¬ | æŠ€è¡“é¸å‹ |
|:-----|:-----|:---------|
| **MCP Server** | æš´éœ²æ‰€æœ‰å·¥å…·ç‚º MCP Protocol | FastMCP / mcp-python |
| **MedVision MCP Agent** | å…§å»ºé†«ç™‚å½±åƒåˆ†æ Agentï¼Œä½¿ç”¨ MCP Tools | LangGraph / ReAct |
| **Multi-Model Tools** | AI æ¨¡å‹å°è£ç‚ºç¨ç«‹ MCP Tools | VQA, Segment, Classify ç­‰ |
| **Session Store** | ç®¡ç†åˆ†ææœƒè©±ç‹€æ…‹ | **SQLite** (æŒä¹…åŒ–) |
| **Model Registry** | ç®¡ç† AI æ¨¡å‹å¯¦ä¾‹ | **vLLM + Ollama** |
| **Canvas UI** | ç¹ªç•«å·¥ä½œå€ï¼Œç”¨æˆ¶èˆ‡ Agent äº’å‹• | **React + Fabric.js** |
| **Event Bus** | å·¥å…·åŸ·è¡Œçµæœæ¨é€åˆ° UI | WebSocket / MCP Resources |

### 2.2.1 ä½¿ç”¨æ¨¡å¼

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                           ä¸‰ç¨®ä½¿ç”¨æ¨¡å¼                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  æ¨¡å¼ 1: å¤–éƒ¨ Agent ç›´æ¥ä½¿ç”¨ Tools                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     MCP Protocol     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                 â”‚
â”‚  â”‚ Claude/GPT   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ MCP Tools        â”‚                 â”‚
â”‚  â”‚ (External)   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ (VQA, Segment..) â”‚                 â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                             â”‚
â”‚  æ¨¡å¼ 2: å¤–éƒ¨ Agent å§”è¨— MedVision MCP Agent (A2A)                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     MCP Protocol     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Internal    â”‚
â”‚  â”‚ Claude/GPT   â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ MedVision MCP Agent     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
â”‚  â”‚ (External)   â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ (Medical Expert) â”‚      Tools      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                             â”‚
â”‚  æ¨¡å¼ 3: Canvas UI ç›´æ¥äº’å‹• (ç¨ç«‹ä½¿ç”¨)                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     MCP Protocol     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     Internal    â”‚
â”‚  â”‚ User +       â”‚ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚ MedVision MCP Agent     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
â”‚  â”‚ Canvas UI    â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚ (Medical Expert) â”‚      Tools      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                 â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 2.3 æŠ€è¡“æ±ºç­–

#### 2.3.1 UI: React + Canvas (VS Code æ•´åˆå„ªå…ˆ)

```
é¸æ“‡ç†ç”±ï¼š
â”œâ”€â”€ VS Code WebView åŸç”Ÿæ”¯æ´ React
â”œâ”€â”€ å¯æ‰“åŒ…ç‚º VS Code Extension (.vsix)
â”œâ”€â”€ Fabric.js / Konva.js æä¾›å®Œæ•´ç¹ªåœ–èƒ½åŠ›
â”œâ”€â”€ åŒä¸€å¥— UI å¯éƒ¨ç½²ç‚º Web / VS Code Extension / Electron
â””â”€â”€ æœªä¾†å¯æ•´åˆ GitHub Copilot Chat

æ¶æ§‹ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  VS Code Extension Host                                 â”‚
â”‚  â”œâ”€â”€ Extension (TypeScript)                             â”‚
â”‚  â”‚   â”œâ”€â”€ MCP Client                                     â”‚
â”‚  â”‚   â””â”€â”€ WebView Provider                               â”‚
â”‚  â””â”€â”€ WebView (React + Canvas)                           â”‚
â”‚      â”œâ”€â”€ Image Viewer                                   â”‚
â”‚      â”œâ”€â”€ Fabric.js Canvas (æ¨™è¨»/ç¹ªåœ–)                   â”‚
â”‚      â””â”€â”€ WebSocket â†” MCP Server                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.2 Session: SQLite

```
é¸æ“‡ç†ç”±ï¼š
â”œâ”€â”€ é›¶ä¾è³´ï¼Œç„¡éœ€é¡å¤–æœå‹™
â”œâ”€â”€ è¼•é‡æŒä¹…åŒ–ï¼Œé‡å•Ÿä¸éºå¤±
â”œâ”€â”€ æ”¯æ´è¤‡é›œæŸ¥è©¢ (æ­·å²åˆ†æã€çµ±è¨ˆ)
â””â”€â”€ æœªä¾†å¯é·ç§»åˆ° PostgreSQL

è¡¨çµæ§‹ï¼š
â”œâ”€â”€ sessions          # æœƒè©±ä¸»è¡¨
â”œâ”€â”€ images            # å½±åƒè¨˜éŒ„
â”œâ”€â”€ analyses          # åˆ†æçµæœ (JSON)
â”œâ”€â”€ annotations       # æ¨™è¨»è¨˜éŒ„
â””â”€â”€ interactions      # äº’å‹•æ­·å²
```

#### 2.3.3 GPU æ¨ç†: vLLM + Ollama

```
é¸æ“‡ç†ç”±ï¼š
â”œâ”€â”€ vLLM: é«˜æ•ˆ LLM æ¨ç†ï¼Œæ”¯æ´ continuous batching
â”œâ”€â”€ Ollama: æ³›ç”¨æœ¬åœ°æ¨¡å‹é‹è¡Œï¼Œæ˜“æ–¼éƒ¨ç½²
â”œâ”€â”€ çµ±ä¸€æ¨ç†å¾Œç«¯ï¼Œç°¡åŒ–æ¨¡å‹ç®¡ç†
â””â”€â”€ æ”¯æ´æ¨¡å‹é‡åŒ– (4bit/8bit)

Lazy Loading ç­–ç•¥ï¼š
â”œâ”€â”€ vLLM é™åˆ¶: ä¸æ”¯æ´å‹•æ…‹æ¨¡å‹åˆ‡æ›ï¼Œæ¯å¯¦ä¾‹ç¶å®šä¸€å€‹æ¨¡å‹
â”œâ”€â”€ Ollama å„ªå‹¢: åŸç”Ÿæ”¯æ´æŒ‰éœ€è¼‰å…¥ï¼Œæœªä½¿ç”¨æ¨¡å‹è‡ªå‹•å¸è¼‰
â”œâ”€â”€ å»ºè­°ç­–ç•¥:
â”‚   â”œâ”€â”€ å°å‹éƒ¨ç½²: ä½¿ç”¨ Ollama ç®¡ç†æ‰€æœ‰æ¨¡å‹ (ç°¡å–®)
â”‚   â”œâ”€â”€ é«˜åå: vLLM å›ºå®šè¼‰å…¥ä¸»è¦æ¨¡å‹ + Ollama å‚™æ´
â”‚   â””â”€â”€ å½ˆæ€§éƒ¨ç½²: Model Registry ç®¡ç†å¤šå€‹ vLLM é€²ç¨‹
â””â”€â”€ è¨˜æ†¶é«”ç®¡ç†: è¨­å®š max_loaded_models é™åˆ¶åŒæ™‚è¼‰å…¥æ•¸

æ¨¡å‹åˆ†é…ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  vLLM (é«˜æ•ˆæ¨ç†ï¼Œå›ºå®šè¼‰å…¥)                              â”‚
â”‚  â”œâ”€â”€ CheXagent-2-3b (VQA)                               â”‚
â”‚  â”œâ”€â”€ LLaVA-Med (é€šç”¨ VQA)                               â”‚
â”‚  â”œâ”€â”€ MAIRA-2 (Grounding)                                â”‚
â”‚  â””â”€â”€ CheXOne (æ–°ä¸€ä»£ CXR)                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Ollama (æ³›ç”¨/æŒ‰éœ€è¼‰å…¥)                                 â”‚
â”‚  â”œâ”€â”€ LLaVA (è¦–è¦ºæ¨¡å‹)                                   â”‚
â”‚  â”œâ”€â”€ Llama 3 (æ–‡å­—æ¨ç†)                                 â”‚
â”‚  â””â”€â”€ å…¶ä»–ç¤¾ç¾¤æ¨¡å‹                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  PyTorch ç›´æ¥è¼‰å…¥ (é LLM)                              â”‚
â”‚  â”œâ”€â”€ DenseNet (åˆ†é¡)                                    â”‚
â”‚  â”œâ”€â”€ PSPNet (å™¨å®˜åˆ†å‰²)                                  â”‚
â”‚  â”œâ”€â”€ Medical-SAM3 (äº’å‹•åˆ†å‰²)                            â”‚
â”‚  â”œâ”€â”€ Roentgen (å½±åƒç”Ÿæˆ)                                â”‚
â”‚  â”œâ”€â”€ BiomedCLIP (Zero-shot)                             â”‚
â”‚  â””â”€â”€ RAD-DINO (Feature Extraction)                      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  timm/OpenCLIP (Pathology)                              â”‚
â”‚  â”œâ”€â”€ Prov-GigaPath (Tile+Slide Encoder)                 â”‚
â”‚  â”œâ”€â”€ UNI2-h (Tile Encoder)                              â”‚
â”‚  â””â”€â”€ CONCH (Vision-Language)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  nnUNet (CT/MRI Segmentation)                           â”‚
â”‚  â””â”€â”€ TotalSegmentator                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### 2.3.4 äº’å‹•åˆ†å‰²: SAM 3 / Medical-SAM3

```
Model Sources:
â”œâ”€â”€ ä¸»è¦: ChongCong/Medical-SAM3 (é†«ç™‚å°ˆç”¨å¾®èª¿ç‰ˆ)
â”‚   â”œâ”€â”€ GitHub: https://github.com/AIM-Research-Lab/Medical-SAM3
â”‚   â”œâ”€â”€ HuggingFace: ChongCong/Medical-SAM3
â”‚   â”œâ”€â”€ 33 å€‹é†«ç™‚è³‡æ–™é›†ã€10 ç¨®å½±åƒæ¨¡æ…‹å¾®èª¿
â”‚   â””â”€â”€ è«–æ–‡: arXiv:2601.10880
â”œâ”€â”€ å‚™é¸: facebook/sam3 (é€šç”¨ç‰ˆ)
â”‚   â”œâ”€â”€ GitHub: https://github.com/facebookresearch/sam3 (7.4k stars)
â”‚   â”œâ”€â”€ HuggingFace: facebook/sam3 (848M params, 1.65M downloads)
â”‚   â””â”€â”€ éœ€è¦ Python 3.12+, PyTorch 2.7+, CUDA 12.6+

é¸æ“‡ç†ç”±ï¼š
â”œâ”€â”€ Medical-SAM3 é‡å°é†«ç™‚å½±åƒå„ªåŒ–
â”œâ”€â”€ æ”¯æ´æ–‡å­— promptï¼ˆé–‹æ”¾è©å½™æ¦‚å¿µåˆ†å‰²ï¼‰
â”œâ”€â”€ æ”¯æ´å½±ç‰‡åˆ†å‰² (æœªä¾†å¯æ“´å±•)
â”œâ”€â”€ æ”¹é€²çš„é‚Šç·£ç²¾åº¦
â””â”€â”€ ä¿ç•™ prompt-driven éˆæ´»æ€§

åŠŸèƒ½ï¼š
â”œâ”€â”€ Text prompt: æ–‡å­—æè¿°åˆ†å‰² ("è‚ºçµç¯€")
â”œâ”€â”€ Point prompt: é»æ“Šåˆ†å‰²
â”œâ”€â”€ Box prompt: æ¡†é¸åˆ†å‰²  
â”œâ”€â”€ Polygon prompt: å¤šé‚Šå½¢åˆ†å‰²
â”œâ”€â”€ Mask refinement: é®ç½©ç²¾ä¿®
â””â”€â”€ Multi-object tracking: å¤šç‰©ä»¶è¿½è¹¤
```

---

## 3. è³‡æ–™æ¨¡å‹

### 3.1 æ ¸å¿ƒå¯¦é«”

```python
from dataclasses import dataclass, field
from typing import Optional, List, Dict, Any, Literal
from datetime import datetime
import uuid

@dataclass
class MedicalImage:
    """é†«ç™‚å½±åƒ"""
    id: str = field(default_factory=lambda: str(uuid.uuid4())[:8])
    path: str = ""
    type: Literal["CXR", "KUB", "EKG", "CT", "MRI", "DICOM", "Other"] = "Other"
    modality: Optional[str] = None  # DICOM modality code
    metadata: Dict[str, Any] = field(default_factory=dict)
    created_at: datetime = field(default_factory=datetime.now)


@dataclass
class Annotation:
    """æ¨™è¨»ï¼ˆAI æˆ–ç”¨æˆ¶ç”¢ç”Ÿï¼‰"""
    id: str = field(default_factory=lambda: str(uuid.uuid4())[:8])
    image_id: str = ""
    type: Literal["bbox", "polygon", "point", "freehand", "mask", "measurement", "text"] = "bbox"
    coordinates: Any = None  # ä¾ type ä¸åŒæ ¼å¼
    label: str = ""
    confidence: Optional[float] = None
    source: Literal["ai", "user", "system"] = "ai"
    notes: Optional[str] = None
    created_at: datetime = field(default_factory=datetime.now)


@dataclass 
class ImageAnalysis:
    """å–®å¼µå½±åƒçš„åˆ†æçµæœ"""
    image_id: str = ""
    classification: Optional[Dict[str, float]] = None
    detections: List[Dict[str, Any]] = field(default_factory=list)
    segmentation: Optional[Dict[str, Any]] = None
    report: Optional[str] = None
    vqa_history: List[Dict[str, str]] = field(default_factory=list)
    created_at: datetime = field(default_factory=datetime.now)


@dataclass
class Interaction:
    """ç”¨æˆ¶äº’å‹•è¨˜éŒ„"""
    id: str = field(default_factory=lambda: str(uuid.uuid4())[:8])
    type: Literal["upload", "region_select", "annotation", "query", "export"] = "query"
    data: Dict[str, Any] = field(default_factory=dict)
    timestamp: datetime = field(default_factory=datetime.now)


@dataclass
class StudySession:
    """åˆ†ææœƒè©±ï¼ˆæ ¸å¿ƒå¯¦é«”ï¼‰"""
    id: str = field(default_factory=lambda: str(uuid.uuid4())[:8])
    
    # å½±åƒé›†åˆ
    images: List[MedicalImage] = field(default_factory=list)
    current_image_id: Optional[str] = None
    
    # åˆ†æçµæœ
    analyses: Dict[str, ImageAnalysis] = field(default_factory=dict)
    
    # æ¨™è¨»
    annotations: List[Annotation] = field(default_factory=list)
    
    # äº’å‹•æ­·å²
    interactions: List[Interaction] = field(default_factory=list)
    
    # ç•¶å‰é¸å®šå€åŸŸ
    current_roi: Optional[Dict[str, Any]] = None
    
    # å…ƒæ•¸æ“š
    created_at: datetime = field(default_factory=datetime.now)
    updated_at: datetime = field(default_factory=datetime.now)
    
    def get_current_image(self) -> Optional[MedicalImage]:
        if not self.current_image_id:
            return self.images[0] if self.images else None
        return next((img for img in self.images if img.id == self.current_image_id), None)
```

### 3.2 åº§æ¨™æ ¼å¼

```python
# BBox: [x1, y1, x2, y2] å·¦ä¸Šè§’å’Œå³ä¸‹è§’ï¼Œå€¼ç‚º 0-1 ç›¸å°åº§æ¨™æˆ–åƒç´ åº§æ¨™
bbox = {"type": "bbox", "coordinates": [0.1, 0.2, 0.3, 0.4], "format": "relative"}

# Polygon: [[x1,y1], [x2,y2], ...] å¤šé‚Šå½¢é ‚é»
polygon = {"type": "polygon", "coordinates": [[100, 200], [150, 200], [150, 250], [100, 250]]}

# Point: [x, y] å–®é»
point = {"type": "point", "coordinates": [200, 300]}

# Mask: äºŒé€²åˆ¶é®ç½©è·¯å¾‘æˆ– base64
mask = {"type": "mask", "path": "temp/mask_001.png"}
```

---

## 4. MCP Tools è¦æ ¼

### 4.1 Session ç®¡ç†

#### `create_study_session`

```python
@mcp.tool
def create_study_session(
    name: Optional[str] = None,
    metadata: Optional[Dict[str, Any]] = None
) -> Dict:
    """
    å‰µå»ºæ–°çš„å½±åƒåˆ†ææœƒè©±
    
    Returns:
        session_id: æœƒè©± ID
        ui_url: äº’å‹• UI URLï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
    """
```

#### `add_image_to_session`

```python
@mcp.tool
def add_image_to_session(
    session_id: str,
    image_path: str,
    image_type: Optional[Literal["CXR", "KUB", "EKG", "CT", "MRI", "DICOM", "Other"]] = None,
    auto_analyze: bool = True,
    analysis_config: Optional[Dict] = None
) -> Dict:
    """
    åŠ å…¥å½±åƒåˆ°æœƒè©±
    
    Args:
        session_id: æœƒè©± ID
        image_path: å½±åƒè·¯å¾‘ï¼ˆæœ¬åœ°æˆ– URLï¼‰
        image_type: å½±åƒé¡å‹ï¼ŒNone æ™‚è‡ªå‹•åµæ¸¬
        auto_analyze: æ˜¯å¦è‡ªå‹•åŸ·è¡Œåˆ†æ
        analysis_config: åˆ†æé…ç½®ï¼ˆè¦‹ analyze_imageï¼‰
    
    Returns:
        image_id: å½±åƒ ID
        type: åµæ¸¬åˆ°çš„å½±åƒé¡å‹
        auto_analysis: è‡ªå‹•åˆ†æçµæœï¼ˆå¦‚æœå•Ÿç”¨ï¼‰
    """
```

#### `get_session_status`

```python
@mcp.tool
def get_session_status(session_id: str) -> Dict:
    """
    å–å¾—æœƒè©±ç‹€æ…‹æ‘˜è¦
    
    Returns:
        session_id: æœƒè©± ID
        images: å½±åƒåˆ—è¡¨æ‘˜è¦
        current_image: ç•¶å‰å½±åƒ ID
        total_annotations: æ¨™è¨»æ•¸é‡
        ui_url: äº’å‹• UI URL
    """
```

#### `switch_image`

```python
@mcp.tool
def switch_image(session_id: str, image_id: str) -> Dict:
    """åˆ‡æ›ç•¶å‰å½±åƒç„¦é»"""
```

---

### 4.2 åˆ†æå·¥å…·

#### `analyze_image`

```python
@mcp.tool
def analyze_image(
    session_id: str,
    image_id: Optional[str] = None,  # None = ç•¶å‰å½±åƒ
    
    # åˆ†æé–‹é—œ
    classify: bool = True,
    detect: bool = True,
    segment: bool = False,
    generate_report: bool = True,
    
    # åˆ†é¡é…ç½®
    classification_threshold: float = 0.5,
    
    # åµæ¸¬é…ç½®
    detection_mode: Literal["auto", "manual", "both"] = "auto",
    detection_phrases: Optional[List[str]] = None,
    
    # åˆ†å‰²é…ç½®
    segment_organs: Optional[List[str]] = None,  # None = å…¨éƒ¨
    
    # é è¨­
    preset: Optional[Literal["quick", "full", "segment_only", "report_only"]] = None
) -> Dict:
    """
    åˆ†æå½±åƒ
    
    Presets:
        - quick: classify only
        - full: classify + detect + segment + report
        - segment_only: segment all organs
        - report_only: generate report only
    
    Returns:
        classification: åˆ†é¡çµæœ
        detections: åµæ¸¬çµæœåˆ—è¡¨
        segmentation: åˆ†å‰²çµæœ
        report: å ±å‘Šæ–‡å­—
        visualization_url: æ•´åˆè¦–è¦ºåŒ– URL
    """
```

#### `ask_about_image`

```python
@mcp.tool
def ask_about_image(
    session_id: str,
    question: str,
    image_id: Optional[str] = None,
    include_context: bool = True  # åŒ…å«å…ˆå‰åˆ†æçµæœä½œç‚ºä¸Šä¸‹æ–‡
) -> Dict:
    """
    å°å½±åƒæå•ï¼ˆVQAï¼‰
    
    Returns:
        answer: å›ç­”æ–‡å­—
        confidence: ä¿¡å¿ƒåº¦
    """
```

---

### 4.3 äº’å‹•å·¥å…·ï¼ˆæ ¸å¿ƒï¼‰

#### `analyze_selected_region`

```python
@mcp.tool
def analyze_selected_region(
    session_id: str,
    region: Dict,  # {"type": "bbox|polygon|point", "coordinates": [...]}
    question: Optional[str] = None,
    actions: List[Literal["describe", "segment", "measure", "compare"]] = ["describe"]
) -> Dict:
    """
    åˆ†æç”¨æˆ¶é¸å®šçš„å€åŸŸ
    
    é€™æ˜¯è™•ç†ç•«æ¿äº’å‹•çš„æ ¸å¿ƒå·¥å…·ã€‚ç•¶ç”¨æˆ¶åœ¨ UI ä¸Šç¹ªè£½å€åŸŸæ™‚ï¼Œ
    UI æœƒè§¸ç™¼æ­¤å·¥å…·èª¿ç”¨ã€‚
    
    Args:
        region: é¸å®šå€åŸŸ
            - bbox: {"type": "bbox", "coordinates": [x1, y1, x2, y2]}
            - polygon: {"type": "polygon", "coordinates": [[x1,y1], ...]}
            - point: {"type": "point", "coordinates": [x, y]}
        question: é—œæ–¼æ­¤å€åŸŸçš„å•é¡Œ
        actions: è¦åŸ·è¡Œçš„å‹•ä½œ
            - describe: æè¿°å€åŸŸå…§å®¹
            - segment: SAM åˆ†å‰²
            - measure: æ¸¬é‡å°ºå¯¸
            - compare: èˆ‡å…¶ä»–å€åŸŸæ¯”è¼ƒ
    
    Returns:
        description: å€åŸŸæè¿°
        segmentation: åˆ†å‰²é®ç½©
        measurements: æ¸¬é‡æ•¸æ“š
        comparison: æ¯”è¼ƒçµæœ
        annotation_id: æ–°å»ºçš„æ¨™è¨» ID
    """
```

#### `add_annotation`

```python
@mcp.tool
def add_annotation(
    session_id: str,
    image_id: Optional[str] = None,
    annotation_type: Literal["bbox", "polygon", "point", "text", "measurement"] = "bbox",
    coordinates: Any = None,
    label: str = "",
    notes: Optional[str] = None
) -> Dict:
    """
    æ‰‹å‹•åŠ å…¥æ¨™è¨»
    
    Returns:
        annotation_id: æ¨™è¨» ID
    """
```

#### `update_annotation`

```python
@mcp.tool
def update_annotation(
    session_id: str,
    annotation_id: str,
    label: Optional[str] = None,
    notes: Optional[str] = None,
    coordinates: Optional[Any] = None
) -> Dict:
    """æ›´æ–°æ¨™è¨»"""
```

#### `delete_annotation`

```python
@mcp.tool
def delete_annotation(session_id: str, annotation_id: str) -> Dict:
    """åˆªé™¤æ¨™è¨»"""
```

---

### 4.4 æŸ¥è©¢å·¥å…·

#### `get_annotations`

```python
@mcp.tool
def get_annotations(
    session_id: str,
    image_id: Optional[str] = None,
    source: Optional[Literal["ai", "user", "all"]] = "all"
) -> Dict:
    """å–å¾—æ¨™è¨»åˆ—è¡¨"""
```

#### `get_analysis_summary`

```python
@mcp.tool
def get_analysis_summary(
    session_id: str,
    image_id: Optional[str] = None
) -> Dict:
    """å–å¾—åˆ†æçµæœæ‘˜è¦"""
```

---

### 4.5 è¼¸å‡ºå·¥å…·

#### `export_study`

```python
@mcp.tool
def export_study(
    session_id: str,
    format: Literal["pdf", "dicom_sr", "json", "png_annotated", "html"] = "pdf",
    include_images: List[str] = [],  # ç©º = å…¨éƒ¨
    include_report: bool = True,
    include_annotations: bool = True,
    include_measurements: bool = True,
    template: Optional[str] = None  # å ±å‘Šæ¨¡æ¿
) -> Dict:
    """
    åŒ¯å‡ºåˆ†æçµæœ
    
    Formats:
        - pdf: PDF å ±å‘Š
        - dicom_sr: DICOM Structured Report
        - json: çµæ§‹åŒ– JSON
        - png_annotated: æ¨™è¨»å¾Œçš„å½±åƒ
        - html: äº’å‹•å¼ HTML
    
    Returns:
        export_path: åŒ¯å‡ºæª”æ¡ˆè·¯å¾‘
        format: åŒ¯å‡ºæ ¼å¼
    """
```

#### `get_visualization`

```python
@mcp.tool
def get_visualization(
    session_id: str,
    image_id: Optional[str] = None,
    include_annotations: bool = True,
    include_segmentation: bool = True,
    include_measurements: bool = True
) -> Dict:
    """
    å–å¾—æ•´åˆè¦–è¦ºåŒ–
    
    Returns:
        image_url: è¦–è¦ºåŒ–å½±åƒ URL
        layers: å„åœ–å±¤è³‡è¨Š
    """
```

---

### 4.6 Agent Tools (A2A)

é€™äº›å·¥å…·ç”¨æ–¼å¤–éƒ¨ Agent å§”è¨— MedVision MCP Agent åŸ·è¡Œä»»å‹™ã€‚

#### `invoke_medical_agent`

```python
@mcp.tool
def invoke_medical_agent(
    session_id: str,
    task: str,
    context: Optional[Dict[str, Any]] = None,
    mode: Literal["auto", "interactive", "step_by_step"] = "auto"
) -> Dict:
    """
    å§”è¨— MedVision MCP Medical Agent åŸ·è¡Œé†«ç™‚å½±åƒåˆ†æä»»å‹™
    
    é€™æ˜¯ A2A (Agent-to-Agent) çš„æ ¸å¿ƒä»‹é¢ã€‚å¤–éƒ¨ Agent (å¦‚ Claude) 
    å¯ä»¥é€éæ­¤å·¥å…·å§”è¨— MedVision MCP Agent åŸ·è¡Œè¤‡é›œçš„é†«ç™‚å½±åƒåˆ†æã€‚
    
    Args:
        session_id: æœƒè©± ID
        task: ä»»å‹™æè¿° (è‡ªç„¶èªè¨€)
            ä¾‹å¦‚: "åˆ†æé€™å¼µ CXRï¼Œæ‰¾å‡ºæ‰€æœ‰ç•°å¸¸"
                 "æ¯”è¼ƒé€™å…©å¼µå½±åƒçš„è®ŠåŒ–"
                 "ç”¨æˆ¶åœ¨å³è‚ºæ¨™è¨˜äº†ä¸€å€‹å€åŸŸï¼Œè«‹è©³ç´°åˆ†æ"
        context: é¡å¤–ä¸Šä¸‹æ–‡
            - user_selection: Canvas ç”¨æˆ¶é¸æ“‡çš„å€åŸŸ
            - previous_findings: å…ˆå‰åˆ†æçµæœ
            - clinical_history: è‡¨åºŠç—…å²
        mode: åŸ·è¡Œæ¨¡å¼
            - auto: è‡ªå‹•åŸ·è¡Œå®Œæ•´æµç¨‹
            - interactive: éœ€è¦æ™‚è©¢å•ç”¨æˆ¶
            - step_by_step: é€æ­¥åŸ·è¡Œï¼Œæ¯æ­¥å›å ±
    
    Returns:
        status: "completed" | "need_input" | "in_progress"
        result: åˆ†æçµæœ
        actions_taken: åŸ·è¡Œçš„å·¥å…·åˆ—è¡¨
        follow_up_suggestions: å»ºè­°çš„å¾ŒçºŒå‹•ä½œ
    """
```

#### `get_agent_capabilities`

```python
@mcp.tool
def get_agent_capabilities() -> Dict:
    """
    å–å¾— MedVision MCP Agent çš„èƒ½åŠ›æ¸…å–®
    
    Returns:
        capabilities: Agent å¯åŸ·è¡Œçš„ä»»å‹™é¡å‹
        supported_modalities: æ”¯æ´çš„å½±åƒé¡å‹
        available_tools: å¯ç”¨çš„ MCP Tools
        agent_model: åº•å±¤ LLM é…ç½®
    """
```

---

### 4.7 Canvas Tools

é€™äº›å·¥å…·å°ˆé–€è™•ç† Canvas ç¹ªç•«å·¥ä½œå€çš„äº’å‹•ã€‚

#### `sync_canvas_state`

```python
@mcp.tool
def sync_canvas_state(
    session_id: str,
    canvas_state: Dict[str, Any]
) -> Dict:
    """
    åŒæ­¥ Canvas ç‹€æ…‹åˆ° Server
    
    Args:
        canvas_state: Canvas ç‹€æ…‹
            - viewport: ç•¶å‰è¦–çª—ä½ç½®/ç¸®æ”¾
            - active_tool: ç•¶å‰å·¥å…·
            - user_drawings: ç”¨æˆ¶ç¹ªè£½çš„åœ–å½¢
            - pending_selection: å¾…è™•ç†çš„é¸æ“‡å€åŸŸ
    """
```

#### `push_to_canvas`

```python
@mcp.tool
def push_to_canvas(
    session_id: str,
    action: Literal["add_layer", "update_layer", "remove_layer", "highlight", "animate"],
    payload: Dict[str, Any]
) -> Dict:
    """
    æ¨é€è¦–è¦ºåŒ–åˆ° Canvas
    
    é€™å…è¨± Agent ä¸»å‹•åœ¨ Canvas ä¸Šé¡¯ç¤ºåˆ†æçµæœã€‚
    
    Args:
        action: å‹•ä½œé¡å‹
        payload: å‹•ä½œè³‡æ–™
            - add_layer: {"type": "segmentation|bbox|annotation", "data": ...}
            - highlight: {"region": {...}, "style": "pulse|glow|outline"}
            - animate: {"from": {...}, "to": {...}, "duration": 500}
    """
```

#### `request_user_input`

```python
@mcp.tool
def request_user_input(
    session_id: str,
    input_type: Literal["select_region", "confirm", "choose", "draw"],
    prompt: str,
    options: Optional[List[Dict]] = None
) -> Dict:
    """
    é€é Canvas è«‹æ±‚ç”¨æˆ¶è¼¸å…¥
    
    Args:
        input_type: è¼¸å…¥é¡å‹
            - select_region: è«‹ç”¨æˆ¶æ¡†é¸å€åŸŸ
            - confirm: æ˜¯/å¦ç¢ºèª
            - choose: å¤šé¸ä¸€
            - draw: è‡ªç”±ç¹ªè£½
        prompt: é¡¯ç¤ºçµ¦ç”¨æˆ¶çš„æç¤º
        options: é¸é … (ç”¨æ–¼ choose)
    
    Returns:
        user_input: ç”¨æˆ¶çš„è¼¸å…¥çµæœ
    """
```

---

### 4.8 Visual RAG Tools (æ··åˆæ¨¡å¼ B)

Visual RAG æ¡ç”¨**æ··åˆæ¨¡å¼**ï¼šDenseNet å¿«é€Ÿåˆ†é¡ + RAG åƒè€ƒæª¢ç´¢ï¼Œè®“å¤–éƒ¨ Agent ç¶œåˆåˆ¤æ–·ã€‚

#### æ¶æ§‹æ¦‚è¿°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     Visual RAG æ··åˆæ¨¡å¼ (Mode B)                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                          â”‚
â”‚  è¼¸å…¥å½±åƒ                                                                 â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                   â”‚
â”‚      â–¼                       â–¼                       â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚
â”‚  â”‚ DenseNet â”‚         â”‚  RAD-DINO    â”‚        â”‚   PSPNet     â”‚           â”‚
â”‚  â”‚ å¿«é€Ÿåˆ†é¡  â”‚         â”‚  Embedding   â”‚        â”‚   å™¨å®˜åˆ†å‰²   â”‚           â”‚
â”‚  â”‚ (18é¡)   â”‚         â”‚  (768-dim)   â”‚        â”‚   (14å™¨å®˜)   â”‚           â”‚
â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜        â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚
â”‚       â”‚                      â”‚                       â”‚                   â”‚
â”‚       â”‚               â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”               â”‚                   â”‚
â”‚       â”‚               â”‚    FAISS     â”‚               â”‚                   â”‚
â”‚       â”‚               â”‚  å‘é‡æª¢ç´¢    â”‚               â”‚                   â”‚
â”‚       â”‚               â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜               â”‚                   â”‚
â”‚       â”‚                      â”‚                       â”‚                   â”‚
â”‚       â–¼                      â–¼                       â–¼                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                    èšåˆçµæœè¿”å›çµ¦ Agent                           â”‚    â”‚
â”‚  â”‚  {                                                               â”‚    â”‚
â”‚  â”‚    "quick_classification": {...},  // DenseNet çµæœ              â”‚    â”‚
â”‚  â”‚    "similar_cases": [...],         // RAG ç›¸ä¼¼æ¡ˆä¾‹+å ±å‘Š          â”‚    â”‚
â”‚  â”‚    "segmentation": {...},          // PSPNet å™¨å®˜åˆ†å‰²            â”‚    â”‚
â”‚  â”‚    "aggregated_labels": [...]      // åŠ æ¬ŠæŠ•ç¥¨æ¨™ç±¤               â”‚    â”‚
â”‚  â”‚  }                                                               â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚       â”‚                                                                  â”‚
â”‚       â–¼                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚           å¤–éƒ¨ Agent (Claude/GPT) ç¶œåˆç”Ÿæˆå ±å‘Š                    â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### `search_similar_cases`

```python
@mcp.tool
def search_similar_cases(
    session_id: str,
    image_id: Optional[str] = None,
    top_k: int = 5,
    include_reports: bool = True,
    include_embeddings: bool = False
) -> Dict:
    """
    ä½¿ç”¨ Visual RAG æœå°‹ç›¸ä¼¼æ­·å²æ¡ˆä¾‹ã€‚
    
    æŠ€è¡“æ£§:
    - RAD-DINO: å½±åƒç·¨ç¢¼ (microsoft/rad-dino, 350MB)
    - FAISS: å‘é‡æª¢ç´¢ (CPU/GPU)
    - Reference DB: MIMIC-CXR embeddings + reports
    
    Args:
        session_id: Session ID
        image_id: å½±åƒ ID (None = ç•¶å‰å½±åƒ)
        top_k: è¿”å›ç›¸ä¼¼æ¡ˆä¾‹æ•¸é‡
        include_reports: æ˜¯å¦åŒ…å«åƒè€ƒå ±å‘Šå…¨æ–‡
        include_embeddings: æ˜¯å¦è¿”å› embedding å‘é‡
    
    Returns:
        similar_cases: ç›¸ä¼¼æ¡ˆä¾‹åˆ—è¡¨
            - case_id: æ¡ˆä¾‹ ID
            - similarity: ç›¸ä¼¼åº¦ (0-1)
            - report: å ±å‘Šæ–‡å­— (å¦‚ include_reports=True)
            - findings: ä¸»è¦ç™¼ç¾
            - labels: æ¨™ç±¤åˆ—è¡¨
            - patient_info: å»è­˜åˆ¥åŒ–æ‚£è€…è³‡è¨Š
        aggregated_labels: åŠ æ¬ŠæŠ•ç¥¨å¾Œçš„å»ºè­°æ¨™ç±¤
            - label: æ¨™ç±¤åç¨±
            - confidence: ä¿¡å¿ƒåº¦ (åŸºæ–¼ç›¸ä¼¼åº¦åŠ æ¬Š)
            - supporting_cases: æ”¯æŒæ­¤æ¨™ç±¤çš„æ¡ˆä¾‹æ•¸
        search_metadata:
            - index_size: å‘é‡åº«å¤§å°
            - search_time_ms: æª¢ç´¢è€—æ™‚
    """
```

#### `analyze_with_rag`

```python
@mcp.tool
def analyze_with_rag(
    session_id: str,
    image_id: Optional[str] = None,
    mode: Literal["quick", "full", "rag_only"] = "full",
    top_k: int = 5
) -> Dict:
    """
    æ··åˆæ¨¡å¼åˆ†æï¼šDenseNet åˆ†é¡ + RAG æª¢ç´¢ã€‚
    
    Modes:
        - quick: åªåŸ·è¡Œ DenseNet åˆ†é¡ (æœ€å¿«)
        - full: DenseNet + RAG + PSPNet (å®Œæ•´)
        - rag_only: åªåŸ·è¡Œ RAG æª¢ç´¢ (ç„¡æ¨¡å‹é™åˆ¶)
    
    Returns:
        quick_classification: DenseNet åˆ†é¡çµæœ (18 é¡)
            - predictions: [{"label": str, "probability": float}, ...]
            - top_finding: æœ€é«˜æ©Ÿç‡ç™¼ç¾
        similar_cases: RAG ç›¸ä¼¼æ¡ˆä¾‹ (åŒ search_similar_cases)
        aggregated_labels: ç¶œåˆå»ºè­°æ¨™ç±¤
        segmentation: å™¨å®˜åˆ†å‰²çµæœ (å¦‚ mode=full)
        suggested_prompt: å»ºè­°çµ¦ LLM çš„å ±å‘Šç”Ÿæˆ prompt
    """
```

#### `build_rag_index`

```python
@mcp.tool
def build_rag_index(
    source: Literal["mimic-cxr", "chexpert", "custom"],
    data_path: Optional[str] = None,
    index_path: str = "./rag_index",
    batch_size: int = 32
) -> Dict:
    """
    å»ºç«‹/æ›´æ–° RAG å‘é‡ç´¢å¼•ã€‚
    
    Args:
        source: è³‡æ–™ä¾†æº
            - mimic-cxr: MIMIC-CXR è³‡æ–™é›† (éœ€ PhysioNet æˆæ¬Š)
            - chexpert: CheXpert è³‡æ–™é›†
            - custom: è‡ªå®šç¾©è³‡æ–™ (éœ€æä¾› data_path)
        data_path: è‡ªå®šç¾©è³‡æ–™è·¯å¾‘ (CSV with image_path, report columns)
        index_path: ç´¢å¼•å„²å­˜è·¯å¾‘
        batch_size: ç·¨ç¢¼æ‰¹æ¬¡å¤§å°
    
    Returns:
        status: å»ºç«‹ç‹€æ…‹
        index_size: ç´¢å¼•å¤§å°
        build_time_s: å»ºç«‹è€—æ™‚
    """
```

#### æ¨¡å‹æ¸…å–® (Visual RAG)

| æ¨¡å‹ | HuggingFace ID | å¤§å° | ç”¨é€” |
|:-----|:---------------|:-----|:-----|
| RAD-DINO | `microsoft/rad-dino` | ~350MB | å½±åƒç·¨ç¢¼ |
| DenseNet-121 | torchxrayvision å…§å»º | ~30MB | å¿«é€Ÿåˆ†é¡ |
| PSPNet | torchxrayvision å…§å»º | ~50MB | å™¨å®˜åˆ†å‰² |
| FAISS | faiss-cpu/faiss-gpu | - | å‘é‡æª¢ç´¢ |

#### å„ªå‹¢

| é¢å‘ | å‚³çµ±æ¨¡å‹ | Visual RAG æ··åˆ |
|:-----|:---------|:----------------|
| **é¡åˆ¥æ•¸** | å›ºå®š 18 é¡ | **ç„¡é™** (ä¾åƒè€ƒåº«) |
| **å¯è§£é‡‹** | âŒ é»‘ç›’ | âœ… æœ‰åƒè€ƒä¾†æº |
| **å ±å‘Šå“è³ª** | æ¨¡å‹æ±ºå®š | **çœŸå¯¦å ±å‘Šåƒè€ƒ** |
| **æ“´å±•æ€§** | æ›æ¨¡å‹ | åŠ åƒè€ƒè³‡æ–™ |
| **ä¸‹è¼‰é‡** | ~15GB | **~400MB** |

---

## 5. Canvas ç¹ªç•«å·¥ä½œå€è¦æ ¼

### 5.1 è¨­è¨ˆç†å¿µ

Canvas ç¹ªç•«å·¥ä½œå€æ˜¯ç”¨æˆ¶èˆ‡ Agent äº’å‹•çš„æ ¸å¿ƒä»‹é¢ã€‚æ‰€æœ‰äº’å‹•éƒ½é€é MCP Protocol é€²è¡Œï¼Œå¯¦ç¾ï¼š
- **ç”¨æˆ¶ â†’ Agent**ï¼šç”¨æˆ¶åœ¨ Canvas ç¹ªè£½å€åŸŸã€é»æ“Šã€æ¨™è¨» â†’ é€é MCP å‚³çµ¦ Agent
- **Agent â†’ Canvas**ï¼šAgent åˆ†æçµæœã€åˆ†å‰²é®ç½©ã€æ¨™è¨» â†’ é€é MCP æ¨é€åˆ° Canvas

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Canvas ç¹ªç•«å·¥ä½œå€                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                      Image + Annotation Layers                        â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                 â”‚  â”‚
â”‚  â”‚   â”‚ Layer 0: Original Image         â”‚                                 â”‚  â”‚
â”‚  â”‚   â”‚ Layer 1: AI Segmentation Masks  â”‚                                 â”‚  â”‚
â”‚  â”‚   â”‚ Layer 2: AI Bounding Boxes      â”‚                                 â”‚  â”‚
â”‚  â”‚   â”‚ Layer 3: User Drawings          â”‚                                 â”‚  â”‚
â”‚  â”‚   â”‚ Layer 4: Measurements           â”‚                                 â”‚  â”‚
â”‚  â”‚   â”‚ Layer 5: Annotations/Labels     â”‚                                 â”‚  â”‚
â”‚  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                 â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â”‚   [Pan] [Zoom+] [Zoom-] [Fit] â”‚ [Select] [BBox] [Polygon] [Point]    â”‚  â”‚
â”‚  â”‚   [Freehand] [Measure] [Text] â”‚ [Undo] [Redo] [Clear] [Layers]       â”‚  â”‚
â”‚  â”‚                                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚  Agent å°è©±å€                        â”‚ â”‚  åˆ†æçµæœé¢æ¿                    â”‚â”‚
â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚ â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€       â”‚â”‚
â”‚  â”‚  ğŸ¤– æˆ‘åˆ†æäº†é€™å¼µ CXRï¼Œç™¼ç¾...        â”‚ â”‚  Classification:                 â”‚â”‚
â”‚  â”‚     [é¡¯ç¤ºå€åŸŸ] [è©³ç´°èªªæ˜]            â”‚ â”‚  â”œâ”€ Cardiomegaly: 0.85          â”‚â”‚
â”‚  â”‚                                     â”‚ â”‚  â””â”€ Effusion: 0.72              â”‚â”‚
â”‚  â”‚  ğŸ‘¤ é€™å€‹å€åŸŸçœ‹èµ·ä¾†ä¸å¤ªå°...          â”‚ â”‚                                  â”‚â”‚
â”‚  â”‚     [ç”¨æˆ¶æ¨™è¨˜çš„å€åŸŸ]                 â”‚ â”‚  Detections: 3 findings         â”‚â”‚
â”‚  â”‚                                     â”‚ â”‚  Segments: 5 organs             â”‚â”‚
â”‚  â”‚  ğŸ¤– è®“æˆ‘ä»”ç´°çœ‹çœ‹é€™å€‹å€åŸŸ...          â”‚ â”‚                                  â”‚â”‚
â”‚  â”‚                                     â”‚ â”‚  [Full Report] [Export]         â”‚â”‚
â”‚  â”‚  [è¼¸å…¥è¨Šæ¯...             ] [é€å‡º]  â”‚ â”‚                                  â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ Image List: [CXR_001 âœ“] [KUB_001] [CT_slice_42] â”‚ [+ Upload]          â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.2 UI æŠ€è¡“å †ç–Š

```
React + TypeScript
â”œâ”€â”€ Fabric.js          # Canvas ç¹ªåœ–/æ¨™è¨»
â”œâ”€â”€ MCP Client         # èˆ‡ MedVision MCP Server é€šè¨Š
â”œâ”€â”€ React Query        # è³‡æ–™åŒæ­¥
â”œâ”€â”€ Zustand            # ç‹€æ…‹ç®¡ç†
â”œâ”€â”€ Tailwind CSS       # æ¨£å¼
â””â”€â”€ SSE / WebSocket    # å³æ™‚æ›´æ–° (MCP Resources è¨‚é–±)
```

### 5.3 MCP é€šè¨Šæµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          MCP Protocol           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Canvas UI    â”‚ â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚  MedVision MCP Server â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                                   â”‚
        â”‚  1. User draws region on canvas                   â”‚
        â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
        â”‚     call_tool("analyze_selected_region", {...})   â”‚
        â”‚                                                   â”‚
        â”‚  2. Agent processes with internal tools           â”‚
        â”‚                    â”‚                              â”‚
        â”‚                    â–¼                              â”‚
        â”‚  3. Server pushes result via MCP Resources        â”‚
        â”‚  â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
        â”‚     resource_update("session/{id}/annotations")   â”‚
        â”‚                                                   â”‚
        â”‚  4. Canvas receives and renders mask              â”‚
        â”‚                                                   â”‚
        â–¼                                                   â–¼
```

### 5.4 UI äº‹ä»¶

| äº‹ä»¶ | è§¸ç™¼æ¢ä»¶ | MCP Tool èª¿ç”¨ |
|:-----|:---------|:-------------|
| `image_uploaded` | ç”¨æˆ¶ä¸Šå‚³å½±åƒ | `add_image_to_session` |
| `region_selected` | ç”¨æˆ¶åœ¨ Canvas ç¹ªè£½å€åŸŸ | `analyze_selected_region` |
| `annotation_added` | ç”¨æˆ¶æ‰‹å‹•åŠ å…¥æ¨™è¨» | `add_annotation` |
| `question_asked` | ç”¨æˆ¶è¼¸å…¥å•é¡Œ | `invoke_medical_agent` æˆ– `ask_about_image` |
| `export_requested` | ç”¨æˆ¶é»æ“ŠåŒ¯å‡º | `export_study` |

### 5.5 MCP Resources è¨‚é–± (Server â†’ UI)

| Resource | æ›´æ–°æ™‚æ©Ÿ | UI å‹•ä½œ |
|:---------|:---------|:--------|
| `session/{id}/image` | ç•¶å‰å½±åƒè®Šæ›´ | é‡æ–°è¼‰å…¥å½±åƒ |
| `session/{id}/annotations` | æ¨™è¨»æ–°å¢/æ›´æ–° | æ›´æ–°æ¨™è¨»åˆ—è¡¨ + Canvas |
| `session/{id}/segmentation` | åˆ†å‰²å®Œæˆ | ç–ŠåŠ åˆ†å‰²é®ç½© |
| `session/{id}/analysis` | åˆ†æé€²åº¦æ›´æ–° | æ›´æ–°åˆ†æé¢æ¿ |
| `session/{id}/agent_message` | Agent å›è¦† | é¡¯ç¤ºåœ¨å°è©±å€ |

---

## 6. æ¥­å‹™æµç¨‹

### 6.1 æ¨™æº–æµç¨‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 1: åˆå§‹åˆ†æ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User: ä¸Šå‚³ CXR
      â†“
Agent: create_study_session()
       add_image_to_session(auto_analyze=True, preset="full")
      â†“
System: åŸ·è¡Œ classify â†’ detect â†’ segment â†’ report
        æ¯æ­¥é©Ÿæ¨é€åˆ° UI
      â†“
Agent: "åˆ†æå®Œæˆï¼ç™¼ç¾ä»¥ä¸‹ç•°å¸¸..."
UI: é¡¯ç¤ºæ¨™è¨»å¾Œçš„å½±åƒ + å ±å‘Š


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 2: äº’å‹•è¨è«–                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User: åœ¨ Canvas ä¸Šæ¡†é¸å€åŸŸ
      "é€™å€‹å€åŸŸæ˜¯ä»€éº¼ï¼Ÿ"
      â†“
UI: ç™¼é€ region_selected äº‹ä»¶
      â†“
Agent: analyze_selected_region(
           region={"type": "bbox", ...},
           question="é€™å€‹å€åŸŸæ˜¯ä»€éº¼ï¼Ÿ",
           actions=["describe", "segment"]
       )
      â†“
System: VQA æè¿° + SAM åˆ†å‰²
        æ¨é€åˆ° UI
      â†“
Agent: "é€™å€‹å€åŸŸé¡¯ç¤º..."
UI: ç–ŠåŠ åˆ†å‰²é®ç½©


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 3: åŠ å…¥æ¨™è¨»                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User: ç¹ªè£½ Polygon ä¸¦æ¨™è¨˜ç‚º "ç–‘ä¼¼ç—…ç¶"
      â†“
UI: ç™¼é€ annotation_added äº‹ä»¶
      â†“
Agent: add_annotation(
           annotation_type="polygon",
           coordinates=[...],
           label="ç–‘ä¼¼ç—…ç¶"
       )
      â†“
UI: æ›´æ–°æ¨™è¨»åˆ—è¡¨


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 4: åˆ‡æ›å½±åƒ                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User: ä¸Šå‚³ KUB
      "é€™å¼µä¹Ÿå¹«æˆ‘åˆ†æ"
      â†“
Agent: add_image_to_session(
           image_path="kub.png",
           auto_analyze=True
       )
      â†“
System: åˆ†æ KUB
UI: åŠ å…¥å½±åƒåˆ—è¡¨ï¼Œåˆ‡æ›é¡¯ç¤º


â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Phase 5: åŒ¯å‡º                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

User: "åŒ¯å‡ºå®Œæ•´å ±å‘Š"
      â†“
Agent: export_study(
           format="pdf",
           include_report=True,
           include_annotations=True
       )
      â†“
System: ç”Ÿæˆ PDF
Agent: "å ±å‘Šå·²åŒ¯å‡º: [ä¸‹è¼‰é€£çµ]"
```

### 6.2 Headless æ¨¡å¼æµç¨‹

```
# ä¸éœ€è¦ UIï¼Œç´” CLI/Agent ä½¿ç”¨

Agent: create_study_session()
Agent: add_image_to_session("cxr.png", auto_analyze=True)
       â†’ å–å¾—åˆ†æçµæœ JSON
Agent: analyze_selected_region(region={...})
       â†’ å–å¾—å€åŸŸåˆ†æçµæœ
Agent: export_study(format="json")
       â†’ å–å¾—åŒ¯å‡ºæª”æ¡ˆè·¯å¾‘
```

---

## 7. AI æ¨¡å‹æ•´åˆ

### 7.1 æ¨¡å‹æ¸…å–®ç¸½è¦½

| é¡åˆ¥ | æ¨¡å‹æ•¸é‡ | ä¸»è¦æ¨¡æ…‹ |
|:-----|:---------|:---------|
| Radiology VLM | 6 | CXR, Multi |
| Medical Image Encoders | 4 | CXR, Multi |
| CT/MRI Segmentation | 1 | CT, MRI |
| Pathology Foundation | 3 | WSI, H&E |
| Interactive Segmentation | 2 | All |
| Legacy (v1) | 4 | CXR |

> **ğŸ“Š è³‡æ–™æŠ“å–æ—¥æœŸ**ï¼šä¸‹åˆ—æ¨¡å‹ä¸‹è¼‰é‡çµ±è¨ˆä¾†è‡ª HuggingFaceï¼ŒæŠ“å–æ—¥æœŸç‚º **2026-02**ã€‚å¯¦éš›æ•¸æ“šå¯èƒ½æœ‰è®Šå‹•ã€‚

### 7.2 Radiology VLM (è¦–è¦ºèªè¨€æ¨¡å‹)

| æ¨¡å‹ | ä¾†æº | åƒæ•¸é‡ | åŠŸèƒ½ | ä¸‹è¼‰é‡ | HuggingFace |
|:-----|:-----|:-------|:-----|:-------|:------------|
| **CheXagent-2-3b** | StanfordAIMI | 3B | VQA, Report Gen, Structured Findings | 1.99k/æœˆ | `StanfordAIMI/CheXagent-2-3b` |
| **CheXOne** | StanfordAIMI | 4B | Image-Text-to-Text (æœ€æ–°) | - | `StanfordAIMI/CheXOne` |
| **CheXagent-8b** | StanfordAIMI | 8B | VQA, Report Gen | 551/æœˆ | `StanfordAIMI/CheXagent-8b` |
| **MAIRA-2** | Microsoft | 7B | Grounded Report Gen, Phrase Grounding | 3.5k/æœˆ | `microsoft/maira-2` |
| **LLaVA-Med-v1.5** | Microsoft | 8B | é€šç”¨é†«ç™‚ VQA | 10.2k/æœˆ | `microsoft/llava-med-v1.5-mistral-7b` |
| **RadFM** | chaoyi-wu | - | Multi-modal Radiology FM | - | `chaoyi-wu/RadFM` |

```
åŠŸèƒ½å°ç…§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨¡å‹                  â”‚ VQA         â”‚ Report Gen   â”‚ Grounding    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ CheXagent-2-3b       â”‚ âœ“           â”‚ âœ“            â”‚ âœ—            â”‚
â”‚ MAIRA-2              â”‚ âœ“           â”‚ âœ“ (grounded) â”‚ âœ“ (bbox)     â”‚
â”‚ LLaVA-Med            â”‚ âœ“           â”‚ âœ“            â”‚ âœ—            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.3 Medical Image Encoders (å½±åƒç·¨ç¢¼å™¨)

| æ¨¡å‹ | ä¾†æº | ç”¨é€” | è¨“ç·´è³‡æ–™ | ä¸‹è¼‰é‡ | HuggingFace |
|:-----|:-----|:-----|:---------|:-------|:------------|
| **BiomedCLIP** | Microsoft | Zero-shot Classification | PMC-15M (15M image-caption pairs) | 713k/æœˆ | `microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224` |
| **RAD-DINO** | Microsoft | CXR Feature Extraction | 882k CXR images | 60k/æœˆ | `microsoft/rad-dino` |
| **MedCLIP** | Community | Medical Image Classification | ROCO Dataset | 43/æœˆ | `kaushalya/medclip` |
| **RadFM Encoder** | chaoyi-wu | Multi-modal Encoding | Multi-modality | - | `chaoyi-wu/RadFM` |

```
BiomedCLIP æ”¯æ´é¡åˆ¥ç¯„ä¾‹ï¼š
â”œâ”€â”€ adenocarcinoma histopathology
â”œâ”€â”€ brain MRI
â”œâ”€â”€ chest X-ray
â”œâ”€â”€ bone X-ray
â”œâ”€â”€ squamous cell carcinoma histopathology
â”œâ”€â”€ immunohistochemistry histopathology
â””â”€â”€ hematoxylin and eosin histopathology
```

### 7.4 CT/MRI Segmentation (å…¨èº«åˆ†å‰²)

| æ¨¡å‹ | ä¾†æº | é¡åˆ¥æ•¸ | æ”¯æ´æ¨¡æ…‹ | GitHub Stars | é€£çµ |
|:-----|:-----|:-------|:---------|:-------------|:-----|
| **TotalSegmentator** | wasserth | 117+ CT, 50+ MRI | CT, MRI | 2.4k | [GitHub](https://github.com/wasserth/TotalSegmentator) |

```
TotalSegmentator ä¸»è¦ä»»å‹™ï¼š
â”œâ”€â”€ total: 117 ä¸»é¡åˆ¥ (CT)
â”œâ”€â”€ total_mr: 50 ä¸»é¡åˆ¥ (MRI)
â”œâ”€â”€ lung_vessels: è‚ºè¡€ç®¡ã€æ°£ç®¡
â”œâ”€â”€ body: èº«é«”ã€è»€å¹¹ã€å››è‚¢ã€çš®è†š
â”œâ”€â”€ vertebrae_mr: è„Šæ¤ (MRI)
â”œâ”€â”€ cerebral_bleed: è…¦å‡ºè¡€
â”œâ”€â”€ pleural_pericard_effusion: èƒ¸è†œ/å¿ƒåŒ…ç©æ¶²
â”œâ”€â”€ head_glands_cavities: é ­éƒ¨è…ºé«”/è…”å®¤
â”œâ”€â”€ liver_vessels: è‚è¡€ç®¡ã€è‚è…«ç˜¤
â”œâ”€â”€ lung_nodules: è‚ºçµç¯€
â”œâ”€â”€ brain_structures: è…¦çµæ§‹
â””â”€â”€ coronary_arteries: å† ç‹€å‹•è„ˆ
```

### 7.5 Pathology Foundation Models (ç—…ç†åŸºç¤æ¨¡å‹)

| æ¨¡å‹ | ä¾†æº | åƒæ•¸é‡ | è¨“ç·´è³‡æ–™ | ä¸‹è¼‰é‡ | License | HuggingFace |
|:-----|:-----|:-------|:---------|:-------|:--------|:------------|
| **Prov-GigaPath** | Microsoft | - | Real-world WSI | 328k/æœˆ | Apache-2.0 | `prov-gigapath/prov-gigapath` |
| **UNI2-h** | MahmoodLab | 681M | 200M+ tiles, 350k slides | 44k/æœˆ | CC-BY-NC-ND-4.0 | `MahmoodLab/UNI2-h` |
| **CONCH** | MahmoodLab | 200M (ViT-B/16 + Text) | 1.17M image-caption pairs | 17k/æœˆ | CC-BY-NC-ND-4.0 | `MahmoodLab/CONCH` |

```
ç—…ç†æ¨¡å‹åŠŸèƒ½å°ç…§ï¼š
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ¨¡å‹                  â”‚ Tile Enc    â”‚ Slide Enc    â”‚ Text Enc     â”‚ Zero-shot â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Prov-GigaPath        â”‚ âœ“           â”‚ âœ“            â”‚ âœ—            â”‚ âœ—         â”‚
â”‚ UNI2-h               â”‚ âœ“           â”‚ (via MIL)    â”‚ âœ—            â”‚ âœ—         â”‚
â”‚ CONCH                â”‚ âœ“           â”‚ (via MIL)    â”‚ âœ“            â”‚ âœ“         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.6 Interactive Segmentation (äº’å‹•åˆ†å‰²)

| æ¨¡å‹ | ä¾†æº | è¨“ç·´è³‡æ–™ | ç‰¹è‰² | é€£çµ |
|:-----|:-----|:---------|:-----|:-----|
| **Medical-SAM3** | ChongCong | 33 datasets, 10 modalities | é†«ç™‚å°ˆç”¨å¾®èª¿ | [GitHub](https://github.com/AIM-Research-Lab/Medical-SAM3) |
| **SAM 3** | Meta | 11M images, 1.1B masks | é€šç”¨ç‰ˆæœ¬, Text prompt | [GitHub](https://github.com/facebookresearch/sam3) |

### 7.7 Legacy Models (v1 ç¹¼æ‰¿)

| æ¨¡å‹ | ç”¨é€” | æ”¯æ´å½±åƒé¡å‹ | æ¨ç†å¾Œç«¯ |
|:-----|:-----|:-------------|:---------|
| **DenseNet (torchxrayvision)** | åˆ†é¡ 18 ç¨®ç—…è®Š | CXR | PyTorch |
| **PSPNet (torchxrayvision)** | å™¨å®˜åˆ†å‰² | CXR | PyTorch |
| **ViT-BERT** | å ±å‘Šç”Ÿæˆ | CXR | PyTorch |
| **Roentgen** | å½±åƒç”Ÿæˆ | CXR | PyTorch |

> **æ³¨æ„**: MedSAM å·²å‡ç´šç‚º SAM 3 / Medical-SAM3ï¼Œæä¾›æ›´å¥½çš„åˆ†å‰²ç²¾åº¦å’Œæ•ˆèƒ½ã€‚

### 7.8 æ¨¡å‹è·¯ç”±

```python
MODEL_ROUTING = {
    "CXR": {
        "classify": ["densenet", "biomedclip"],
        "encode": "rad-dino",
        "segment": "pspnet",
        "vqa": "chexagent-2",
        "ground": "maira2",
        "report": ["chexagent-2", "vit-bert"],
        "interactive_segment": "medical-sam3",
    },
    "KUB": {
        "classify": "biomedclip",
        "vqa": "llava-med",
        "interactive_segment": "medical-sam3",
    },
    "CT": {
        "segment_anatomy": "totalsegmentator",
        "vqa": "llava-med",
        "interactive_segment": "medical-sam3",
    },
    "MRI": {
        "segment_anatomy": "totalsegmentator",  # total_mr task
        "vqa": "llava-med",
        "interactive_segment": "medical-sam3",
    },
    "Pathology": {
        "encode_tile": ["prov-gigapath", "uni2-h", "conch"],
        "encode_slide": "prov-gigapath",
        "zero_shot": "conch",
        "interactive_segment": "sam3",
    },
    "EKG": {
        "vqa": "llava-med",
    },
    "Other": {
        "classify": "biomedclip",
        "vqa": "llava-med",
        "interactive_segment": "sam3",
    }
}
```

### 7.9 æ¨¡å‹è¼‰å…¥ç­–ç•¥

```python
from vllm import LLM, SamplingParams
import ollama

class ModelRegistry:
    """çµ±ä¸€æ¨¡å‹ç®¡ç†ï¼Œæ”¯æ´ vLLMã€Ollamaã€PyTorch"""
    
    def __init__(self, model_dir: str, device: str = "cuda"):
        self.model_dir = model_dir
        self.device = device
        self._pytorch_models: Dict[str, Any] = {}
        self._vllm_models: Dict[str, LLM] = {}
        self._ollama_client = ollama.Client()
    
    def get_pytorch(self, model_name: str) -> Any:
        """PyTorch æ¨¡å‹ï¼ˆåˆ†é¡ã€åˆ†å‰²ã€SAMï¼‰"""
        if model_name not in self._pytorch_models:
            self._pytorch_models[model_name] = self._load_pytorch(model_name)
        return self._pytorch_models[model_name]
    
    def get_vllm(self, model_name: str) -> LLM:
        """vLLM æ¨¡å‹ï¼ˆé«˜æ•ˆ VQA/LLMï¼‰"""
        if model_name not in self._vllm_models:
            self._vllm_models[model_name] = LLM(
                model=self._get_model_path(model_name),
                tensor_parallel_size=1,
                gpu_memory_utilization=0.8,
                quantization="awq",  # æˆ– "gptq"
            )
        return self._vllm_models[model_name]
    
    def call_ollama(self, model_name: str, prompt: str, images: List[str] = None) -> str:
        """Ollama æ¨¡å‹ï¼ˆæ³›ç”¨/å‚™æ´ï¼‰"""
        response = self._ollama_client.chat(
            model=model_name,
            messages=[{
                "role": "user",
                "content": prompt,
                "images": images or []
            }]
        )
        return response["message"]["content"]
    
    def unload(self, model_name: str):
        if model_name in self._pytorch_models:
            del self._pytorch_models[model_name]
        if model_name in self._vllm_models:
            del self._vllm_models[model_name]
        torch.cuda.empty_cache()
```

### 7.10 vLLM é…ç½®

```yaml
# vllm_config.yaml
models:
  chexagent-2:
    model_path: "StanfordAIMI/CheXagent-2-3b"
    tensor_parallel_size: 1
    gpu_memory_utilization: 0.4
    max_model_len: 4096
    quantization: "awq"
    
  llava-med:
    model_path: "microsoft/llava-med-v1.5-mistral-7b"
    tensor_parallel_size: 1
    gpu_memory_utilization: 0.4
    max_model_len: 4096
    quantization: "gptq"

  maira2:
    model_path: "microsoft/maira-2"
    tensor_parallel_size: 1
    gpu_memory_utilization: 0.3
    trust_remote_code: true
    
  chexone:
    model_path: "StanfordAIMI/CheXOne"
    tensor_parallel_size: 1
    gpu_memory_utilization: 0.5
    max_model_len: 4096
```

### 7.11 Ollama é…ç½®

```yaml
# ollama_config.yaml
models:
  # é è¼‰æ¨¡å‹
  preload:
    - llava:13b
    - llama3:8b
  
  # æ¨¡å‹å°æ‡‰
  aliases:
    vision: llava:13b
    text: llama3:8b
    medical: llava-med:latest  # è‡ªè¨‚æ¨¡å‹
```

---

## 8. æŠ€è¡“è¦æ ¼

### 8.1 ä¾è³´

```toml
[project]
requires-python = ">=3.11"

[project.dependencies]
# MCP
mcp = ">=1.0.0"
fastmcp = ">=0.1.0"

# AI Inference
torch = ">=2.2.0"
transformers = ">=4.40.0"
vllm = ">=0.4.0"
ollama = ">=0.2.0"

# Vision Models
torchxrayvision = ">=1.0.0"
segment-anything-3 = ">=1.0.0"  # SAM 3 / Medical-SAM3
timm = ">=0.9.8"                 # UNI2-h, Prov-GigaPath
open_clip_torch = ">=2.23.0"     # BiomedCLIP, CONCH

# TotalSegmentator (CT/MRI)
TotalSegmentator = ">=2.0.0"

# Image Processing
pillow = ">=10.0.0"
opencv-python = ">=4.8.0"
scikit-image = ">=0.21.0"
nibabel = ">=5.0.0"              # NIfTI for CT/MRI

# Database
sqlalchemy = ">=2.0.0"
aiosqlite = ">=0.19.0"

# Web/UI
fastapi = ">=0.110.0"
websockets = ">=12.0"
uvicorn = ">=0.27.0"

# Utilities
pydantic = ">=2.0.0"
python-dotenv = ">=1.0.0"
huggingface-hub = ">=0.20.0"     # Model downloads

[project.optional-dependencies]
ui = [
    "gradio>=5.0.0",  # å‚™ç”¨ UI
]
vscode = [
    # VS Code Extension åœ¨ TypeScript å°ˆæ¡ˆä¸­
]
pathology = [
    "openslide-python>=1.3.0",   # WSI è®€å–
    "cucim>=24.0.0",             # GPU-accelerated WSI
]
```

### 8.2 ç›®éŒ„çµæ§‹

```
medvision-mcp/
â”œâ”€â”€ mcp_server/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ server.py              # MCP Server å…¥å£
â”‚   â”œâ”€â”€ tools/
â”‚   â”‚   â”œâ”€â”€ __init__.py
â”‚   â”‚   â”œâ”€â”€ session.py         # Session ç®¡ç†å·¥å…·
â”‚   â”‚   â”œâ”€â”€ analysis.py        # åˆ†æå·¥å…·
â”‚   â”‚   â”œâ”€â”€ interactive.py     # äº’å‹•å·¥å…·
â”‚   â”‚   â”œâ”€â”€ query.py           # æŸ¥è©¢å·¥å…·
â”‚   â”‚   â””â”€â”€ export.py          # åŒ¯å‡ºå·¥å…·
â”‚   â””â”€â”€ schemas/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ models.py          # Pydantic æ¨¡å‹
â”‚
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ session.py             # Session ç®¡ç†
â”‚   â”œâ”€â”€ database.py            # SQLite é€£æ¥
â”‚   â”œâ”€â”€ models.py              # SQLAlchemy æ¨¡å‹
â”‚   â”œâ”€â”€ registry.py            # æ¨¡å‹è¨»å†Š (vLLM/Ollama/PyTorch)
â”‚   â””â”€â”€ router.py              # æ¨¡å‹è·¯ç”±
â”‚
â”œâ”€â”€ inference/                 # æ¨ç†å¾Œç«¯
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ vllm_backend.py        # vLLM æ¨ç†
â”‚   â”œâ”€â”€ ollama_backend.py      # Ollama æ¨ç†
â”‚   â””â”€â”€ pytorch_backend.py     # PyTorch ç›´æ¥æ¨ç†
â”‚
â”œâ”€â”€ models/                    # AI æ¨¡å‹å°è£
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ classification.py      # DenseNet, BiomedCLIP
â”‚   â”œâ”€â”€ segmentation.py        # PSPNet
â”‚   â”œâ”€â”€ grounding.py           # MAIRA-2
â”‚   â”œâ”€â”€ vqa.py                 # CheXagent, LLaVA-Med
â”‚   â”œâ”€â”€ report.py              # Report Generation
â”‚   â”œâ”€â”€ sam3.py                # SAM 3 / Medical-SAM3 äº’å‹•åˆ†å‰²
â”‚   â”œâ”€â”€ encoders.py            # RAD-DINO, BiomedCLIP
â”‚   â”œâ”€â”€ totalsegmentator.py    # CT/MRI è§£å‰–åˆ†å‰²
â”‚   â””â”€â”€ pathology/             # ç—…ç†æ¨¡å‹
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ gigapath.py        # Prov-GigaPath
â”‚       â”œâ”€â”€ uni.py             # UNI2-h
â”‚       â””â”€â”€ conch.py           # CONCH
â”‚
â”œâ”€â”€ api/                       # REST API (çµ¦ UI ç”¨)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ server.py              # FastAPI å…¥å£
â”‚   â”œâ”€â”€ routes/
â”‚   â”‚   â”œâ”€â”€ sessions.py
â”‚   â”‚   â”œâ”€â”€ images.py
â”‚   â”‚   â””â”€â”€ websocket.py       # WebSocket äº‹ä»¶
â”‚   â””â”€â”€ deps.py                # ä¾è³´æ³¨å…¥
â”‚
â”œâ”€â”€ ui/                        # å‚™ç”¨ Gradio UI
â”‚   â”œâ”€â”€ __init__.py
â”‚   â””â”€â”€ app.py
â”‚
â”œâ”€â”€ utils/
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ image.py               # å½±åƒè™•ç†
â”‚   â”œâ”€â”€ dicom.py               # DICOM è™•ç†
â”‚   â””â”€â”€ export.py              # åŒ¯å‡ºåŠŸèƒ½
â”‚
â”œâ”€â”€ db/
â”‚   â””â”€â”€ medvision-mcp.db              # SQLite è³‡æ–™åº«
â”‚
â””â”€â”€ legacy/                    # ä¿ç•™èˆŠç‰ˆç›¸å®¹
    â”œâ”€â”€ agent.py
    â””â”€â”€ tools.py

# VS Code Extension (ç¨ç«‹å°ˆæ¡ˆ)
medvision-mcp-vscode/
â”œâ”€â”€ package.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ extension.ts           # Extension å…¥å£
â”‚   â”œâ”€â”€ mcpClient.ts           # MCP å®¢æˆ¶ç«¯
â”‚   â””â”€â”€ webview/
â”‚       â”œâ”€â”€ App.tsx            # React App
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ ImageViewer.tsx
â”‚       â”‚   â”œâ”€â”€ Canvas.tsx     # Fabric.js ç•«æ¿
â”‚       â”‚   â”œâ”€â”€ AnnotationList.tsx
â”‚       â”‚   â””â”€â”€ AnalysisPanel.tsx
â”‚       â””â”€â”€ hooks/
â”‚           â””â”€â”€ useMCP.ts      # MCP èª¿ç”¨ hook
â””â”€â”€ tsconfig.json
```

### 8.3 é…ç½®

```yaml
# config.yaml
server:
  host: "0.0.0.0"
  mcp_port: 8000
  api_port: 8001
  ui_port: 7860

database:
  url: "sqlite:///db/medvision-mcp.db"
  echo: false  # SQL logging

inference:
  # vLLM é…ç½®
  vllm:
    enabled: true
    gpu_memory_utilization: 0.8
    tensor_parallel_size: 1
    models:
      - chexagent
      - llava-med
      - maira2
  
  # Ollama é…ç½®
  ollama:
    enabled: true
    host: "http://localhost:11434"
    models:
      - llava:13b
      - llama3:8b
  
  # PyTorch ç›´æ¥è¼‰å…¥
  pytorch:
    device: "cuda"
    models:
      - densenet
      - pspnet
      - sam3
      - roentgen

models:
  dir: "/model-weights"
  cache_dir: "/model-cache"

session:
  ttl: 86400  # 24 hours
  cleanup_interval: 3600  # 1 hour

ui:
  enabled: true
  canvas:
    max_width: 2048
    max_height: 2048
    default_tools: ["pan", "zoom", "bbox", "polygon", "point"]

export:
  dir: "exports"
  templates:
    - "default"
    - "clinical"
    - "research"
```

### 8.4 SQLite Schema

```sql
-- sessions è¡¨
CREATE TABLE sessions (
    id TEXT PRIMARY KEY,
    name TEXT,
    current_image_id TEXT,
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- images è¡¨
CREATE TABLE images (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    path TEXT NOT NULL,
    type TEXT NOT NULL,  -- CXR, KUB, EKG, CT, MRI, DICOM, Other
    modality TEXT,
    metadata JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

-- analyses è¡¨
CREATE TABLE analyses (
    id TEXT PRIMARY KEY,
    image_id TEXT NOT NULL,
    classification JSON,
    detections JSON,
    segmentation JSON,
    report TEXT,
    vqa_history JSON,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE
);

-- annotations è¡¨
CREATE TABLE annotations (
    id TEXT PRIMARY KEY,
    image_id TEXT NOT NULL,
    type TEXT NOT NULL,  -- bbox, polygon, point, mask, measurement, text
    coordinates JSON NOT NULL,
    label TEXT,
    confidence REAL,
    source TEXT NOT NULL,  -- ai, user, system
    notes TEXT,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (image_id) REFERENCES images(id) ON DELETE CASCADE
);

-- interactions è¡¨
CREATE TABLE interactions (
    id TEXT PRIMARY KEY,
    session_id TEXT NOT NULL,
    type TEXT NOT NULL,  -- upload, region_select, annotation, query, export
    data JSON,
    timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (session_id) REFERENCES sessions(id) ON DELETE CASCADE
);

-- ç´¢å¼•
CREATE INDEX idx_images_session ON images(session_id);
CREATE INDEX idx_analyses_image ON analyses(image_id);
CREATE INDEX idx_annotations_image ON annotations(image_id);
CREATE INDEX idx_interactions_session ON interactions(session_id);
```

---

## 9. API ç¯„ä¾‹

### 9.1 MCP èª¿ç”¨ç¯„ä¾‹

```python
# ä½¿ç”¨ mcp client
from mcp import Client

async with Client("http://localhost:8000") as client:
    # å‰µå»º Session
    result = await client.call_tool("create_study_session", {})
    session_id = result["session_id"]
    
    # åŠ å…¥å½±åƒä¸¦åˆ†æ
    result = await client.call_tool("add_image_to_session", {
        "session_id": session_id,
        "image_path": "/path/to/cxr.png",
        "auto_analyze": True,
        "analysis_config": {"preset": "full"}
    })
    
    # åˆ†æé¸å®šå€åŸŸ
    result = await client.call_tool("analyze_selected_region", {
        "session_id": session_id,
        "region": {"type": "bbox", "coordinates": [100, 200, 200, 300]},
        "question": "é€™æ˜¯ä»€éº¼ï¼Ÿ",
        "actions": ["describe", "segment"]
    })
    
    # åŒ¯å‡º
    result = await client.call_tool("export_study", {
        "session_id": session_id,
        "format": "pdf"
    })
```

### 9.2 Claude Desktop ä½¿ç”¨

```json
// claude_desktop_config.json
{
  "mcpServers": {
    "medvision-mcp": {
      "command": "python",
      "args": ["-m", "medvision-mcp.mcp_server"],
      "env": {
        "MODEL_DIR": "/model-weights"
      }
    }
  }
}
```

---

## 10. é–‹ç™¼éšæ®µ (ROADMAP)

> **ğŸ”„ ç­–ç•¥èª¿æ•´ (2026-02)**ï¼šåŸè¨ˆç•«ä¾è³´ CheXagent VLMï¼Œå› ä¸‹è¼‰é€Ÿåº¦å•é¡Œ (~315 å°æ™‚)ï¼Œæ”¹æ¡ **Visual RAG Mode B** ç­–ç•¥ï¼šè¼•é‡æ¨¡å‹ + æª¢ç´¢ã€‚

### 10.1 ç•¶å‰ç‹€æ…‹ (2026-02-02)

| æ¨¡çµ„ | ç‹€æ…‹ | èªªæ˜ |
|:-----|:-----|:-----|
| **RAD-DINO** | âœ… Ready | 346MB, 768-dim embedding, ~2s/image |
| **FAISS** | âœ… Ready | L2 å‘é‡æª¢ç´¢, <1ms |
| **DenseNet-121** | âœ… Ready | 18 é¡ CXR åˆ†é¡ |
| **PSPNet** | âœ… Ready | 14 å™¨å®˜åˆ†å‰² |
| **Ollama + LLaVA** | âœ… Ready | æ–‡å­—æ¨¡å¼å¯ç”¨, è¦–è¦ºæ¨¡å¼å¾…ä¿®å¾© |
| **DICOM Processor** | âœ… Ready | pydicom + Window/Level |
| **Report Generator** | âœ… Ready | ViT-BERT æ¬Šé‡å·²ä¸‹è¼‰ |
| **MCP Server** | âŒ æœªå¯¦ä½œ | FastMCP æ¡†æ¶å¾…å»ºç«‹ |
| **Canvas UI** | âŒ æœªå¯¦ä½œ | React + Fabric.js |

### 10.2 æ–°ç‰ˆ MVP å®šç¾© (Visual RAG Mode B)

> **MVP ç›®æ¨™**ï¼šå¯é‹è¡Œçš„ MCP Server + Visual RAG æ ¸å¿ƒæµç¨‹

```
MVP æ ¸å¿ƒåŠŸèƒ½ (Phase 1)ï¼š
âœ… MCP Server å•Ÿå‹• (FastMCP + stdio)
âœ… Visual RAG Pipeline:
   â”œâ”€ RAD-DINO å½±åƒç·¨ç¢¼
   â”œâ”€ FAISS ç›¸ä¼¼æ¡ˆä¾‹æª¢ç´¢
   â””â”€ DenseNet å¿«é€Ÿåˆ†é¡
âœ… æ ¸å¿ƒ Tools:
   â”œâ”€ analyze_image (åˆ†é¡)
   â”œâ”€ search_similar_cases (RAG)
   â””â”€ analyze_with_rag (æ··åˆ)
âœ… SQLite Session ç®¡ç†

MVP å»¶å¾ŒåŠŸèƒ½ï¼š
âŒ Canvas UI (Phase 2)
âŒ äº’å‹•åˆ†å‰² SAM3 (Phase 3)
âŒ VS Code Extension (Phase 4)
âŒ å…§å»º Agent A2A (Phase 3)
```

### 10.3 Phase å®šç¾©

#### Phase 1: Visual RAG Core (Week 1-2)

```
å„ªå…ˆä»»å‹™ï¼š
â”œâ”€â”€ [x] RAD-DINO + FAISS é©—è­‰ (å·²å®Œæˆ)
â”œâ”€â”€ [x] DenseNet + PSPNet é©—è­‰ (å·²å®Œæˆ)
â”œâ”€â”€ [ ] FastMCP Server æ¡†æ¶
â”‚   â”œâ”€â”€ å°ˆæ¡ˆçµæ§‹ (src/medvision_mcp/)
â”‚   â”œâ”€â”€ MCP stdio transport
â”‚   â””â”€â”€ Tool è¨»å†Šæ©Ÿåˆ¶
â”œâ”€â”€ [ ] æ ¸å¿ƒ Tools å¯¦ä½œ
â”‚   â”œâ”€â”€ create_study_session
â”‚   â”œâ”€â”€ add_image_to_session
â”‚   â”œâ”€â”€ analyze_image (DenseNet)
â”‚   â”œâ”€â”€ search_similar_cases (RAD-DINO + FAISS)
â”‚   â””â”€â”€ analyze_with_rag (æ··åˆ)
â”œâ”€â”€ [ ] Reference Database
â”‚   â”œâ”€â”€ SQLite schema
â”‚   â”œâ”€â”€ EURORAD æ¡ˆä¾‹åŒ¯å…¥
â”‚   â””â”€â”€ Embedding é è¨ˆç®—
â””â”€â”€ [ ] åŸºæœ¬æ¸¬è©¦ + Claude Desktop æ•´åˆ
```

#### Phase 2: Canvas UI (Week 3-4)

```
ä»»å‹™ï¼š
â”œâ”€â”€ [ ] React + Vite å°ˆæ¡ˆ
â”œâ”€â”€ [ ] Fabric.js Canvas çµ„ä»¶
â”œâ”€â”€ [ ] MCP Client (stdio)
â”œâ”€â”€ [ ] åŸºæœ¬ç¹ªåœ–å·¥å…· (bbox, polygon)
â”œâ”€â”€ [ ] analyze_selected_region Tool
â””â”€â”€ [ ] å€åŸŸ â†’ RAG æŸ¥è©¢å®Œæ•´æµç¨‹
```

#### Phase 3: Agent + SAM3 (Week 5-6)

```
ä»»å‹™ï¼š
â”œâ”€â”€ [ ] Medical-SAM3 æ•´åˆ
â”œâ”€â”€ [ ] invoke_medical_agent Tool
â”œâ”€â”€ [ ] LangGraph Agent æ¶æ§‹
â”œâ”€â”€ [ ] push_to_canvas é›™å‘äº’å‹•
â””â”€â”€ [ ] å¤šè¼ªå°è©±æ”¯æ´
```

#### Phase 4: VS Code Extension (Week 7-8)

```
ä»»å‹™ï¼š
â”œâ”€â”€ [ ] Extension å°ˆæ¡ˆçµæ§‹
â”œâ”€â”€ [ ] WebView æ•´åˆ Canvas
â”œâ”€â”€ [ ] å‘½ä»¤è¨»å†Š
â””â”€â”€ [ ] ç™¼å¸ƒæº–å‚™
```

#### Phase 5: Polish (Week 9-10)

```
ä»»å‹™ï¼š
â”œâ”€â”€ [ ] Export åŠŸèƒ½ (PDF, JSON)
â”œâ”€â”€ [ ] æ•ˆèƒ½å„ªåŒ–
â”œâ”€â”€ [ ] æ–‡æª”å®Œå–„
â””â”€â”€ [ ] å…¬é–‹ç™¼å¸ƒ
```

### 10.4 æŠ€è¡“ä¾è³´åœ–

```
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚                   Phase 1 (Core)                    â”‚
               â”‚                                                     â”‚
               â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
               â”‚  â”‚RAD-DINO â”‚   â”‚ FAISS   â”‚   â”‚ DenseNet/PSPNet â”‚   â”‚
               â”‚  â”‚ (âœ…)    â”‚   â”‚ (âœ…)    â”‚   â”‚     (âœ…)        â”‚   â”‚
               â”‚  â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
               â”‚       â”‚             â”‚                  â”‚            â”‚
               â”‚       â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜            â”‚
               â”‚              â”‚                 â”‚                    â”‚
               â”‚        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”              â”‚
               â”‚        â”‚ MCP Tools â”‚     â”‚  SQLite   â”‚              â”‚
               â”‚        â”‚  (å¾…å¯¦ä½œ) â”‚     â”‚  (å¾…å¯¦ä½œ) â”‚              â”‚
               â”‚        â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜              â”‚
               â”‚              â”‚                 â”‚                    â”‚
               â”‚        â”Œâ”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”              â”‚
               â”‚        â”‚      FastMCP Server         â”‚              â”‚
               â”‚        â”‚         (å¾…å¯¦ä½œ)            â”‚              â”‚
               â”‚        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
               â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                       â”‚ stdio
                       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                       â”‚       Claude Desktop          â”‚
                       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 11. å·²æ±ºå®šäº‹é …

| é …ç›® | æ±ºå®š | å‚™è¨» |
|:-----|:-----|:-----|
| **æ•´é«”æ¶æ§‹** | MCP Server + Multi-Model Tools + å…§å»º Agent | A2A-like è¨­è¨ˆ |
| **æ ¸å¿ƒç­–ç•¥** | **Visual RAG Mode B** | RAD-DINO + FAISS + DenseNet (2026-02 æ±ºè­°) |
| **Agent è¨­è¨ˆ** | å…§å»º MedVision MCP Medical Agent | ä½¿ç”¨ MCP Toolsï¼Œæ”¯æ´å¤–éƒ¨ Agent å§”è¨— |
| **Canvas UI** | React + Fabric.js ç¹ªç•«å·¥ä½œå€ | é€é MCP Protocol èˆ‡ Agent äº’å‹• |
| Session æŒä¹…åŒ– | **SQLite** | è¼•é‡ã€ç„¡ä¾è³´ã€å¯æŒä¹…åŒ– |
| GPU æ¨ç† | **Ollama (ä¸») + PyTorch ç›´æ¥è¼‰å…¥** | vLLM å‚™é¸ (éœ€å¤§æ¨¡å‹æ™‚) |
| äº’å‹•åˆ†å‰² | **Medical-SAM3** | é†«ç™‚å°ˆç”¨å¾®èª¿ç‰ˆ |
| UI æ¡†æ¶ | **React + Fabric.js** | VS Code WebView ç›¸å®¹ |
| MCP Transport | **stdio å„ªå…ˆ** | å¾ŒçºŒå¯åŠ  HTTP/SSE |
| MVP æ¨¡å‹ | **DenseNet + RAG + Ollama** | é¿å… CheXagent ä¸‹è¼‰ç“¶é ¸ |
| å½±åƒç·¨ç¢¼å™¨ | **RAD-DINO** | 768-dim, 346MB, å·²é©—è­‰ |
| å‘é‡æª¢ç´¢ | **FAISS (CPU)** | L2 è·é›¢, <1ms |

## 12. å¾…è¨è«–äº‹é …

### Post-MVP

1. **å…§å»º Agent å¯¦ä½œ**ï¼š
   - ä½¿ç”¨ LangGraph ReAct é‚„æ˜¯ç°¡å–®çš„ Chainï¼Ÿ
   - Agent åº•å±¤æ¨¡å‹ï¼šä½¿ç”¨ Ollama LLaVA é‚„æ˜¯ Claude/GPT APIï¼Ÿ
   
2. **Canvas äº’å‹•ç´°ç¯€**ï¼š
   - å¤šé¸å€åŸŸåŒæ™‚åˆ†æï¼Ÿ
   - æ˜¯å¦æ”¯æ´é€£çºŒç¹ªåœ–æ¨¡å¼ï¼Ÿ

3. **A2A å”è­°**ï¼š
   - éœ€è¦æ¨™æº–åŒ–çš„ Agent å§”è¨—æ ¼å¼å—ï¼Ÿ
   - æ˜¯å¦éœ€è¦ Agent é–“çš„ç‹€æ…‹å…±äº«ï¼Ÿ

4. **å¤šç”¨æˆ¶æ”¯æ´**ï¼šæ˜¯å¦éœ€è¦ç”¨æˆ¶èªè­‰ï¼ŸToken-based or Session-based?

5. **æ–°å½±åƒé¡å‹æ¨¡å‹**ï¼š
    - KUB: ä½¿ç”¨ LLaVA-Medï¼Œé‚„æ˜¯éœ€è¦å°ˆé–€è¨“ç·´ï¼Ÿ
    - EKG: éœ€è¦å°ˆé–€çš„ ECG åˆ†ææ¨¡å‹å—ï¼Ÿ(å¦‚ ECG-FM)

6. **DICOM SR æ¨™æº–**ï¼šè¦æ”¯æ´å“ªäº› templateï¼ŸTID 1500 (Measurement Report)?

7. **VS Code Extension ç™¼å¸ƒ**ï¼š
    - å…¬é–‹ Marketplace é‚„æ˜¯ç§æœ‰ï¼Ÿ
    - éœ€è¦ç°½ç½²å—ï¼Ÿ

8. **å½±åƒå„²å­˜**ï¼š
    - å½±åƒå­˜åœ¨æœ¬åœ° vs é›²ç«¯ï¼Ÿ
    - éœ€è¦å£“ç¸®/ç¸®åœ–å—ï¼Ÿ

9. **Ollama è¦–è¦ºæ¨¡å¼**ï¼š
    - llava:7b runner éŒ¯èª¤å¾…ä¿®å¾©
    - æ˜¯å¦æ”¹ç”¨ vLLM æˆ–ç›´æ¥è¼‰å…¥æ¨¡å‹ï¼Ÿ

---

## é™„éŒ„ A: ç¾æœ‰å·¥å…·å°ç…§

| v1 å·¥å…· | v2 MCP å·¥å…· | æ¨ç†å¾Œç«¯ | æ–°å¢æ¨¡å‹é¸é … |
|:--------|:-----------|:---------|:-------------|
| ChestXRayClassifierTool | analyze_image(classify=True) | PyTorch | BiomedCLIP, RAD-DINO |
| ChestXRaySegmentationTool | analyze_image(segment=True) | PyTorch | TotalSegmentator (CT/MRI) |
| XRayVQATool | ask_about_image | vLLM | CheXagent-2, CheXOne |
| XRayPhraseGroundingTool | analyze_image(detect=True) | vLLM | MAIRA-2 |
| ChestXRayReportGeneratorTool | analyze_image(generate_report=True) | PyTorch/vLLM | CheXagent-2 |
| LlavaMedTool | ask_about_image | vLLM/Ollama | - |
| ChestXRayGeneratorTool | generate_image (æ–°å¢) | PyTorch | - |
| DicomProcessorTool | add_image_to_session | - | - |
| ImageVisualizerTool | get_visualization | - | - |
| (æ–°å¢) | analyze_selected_region | SAM 3 + vLLM | Medical-SAM3 |
| (æ–°å¢) | analyze_pathology | PyTorch | Prov-GigaPath, UNI2-h, CONCH |
| (æ–°å¢) | segment_anatomy | PyTorch | TotalSegmentator |
| (æ–°å¢ - Agent) | invoke_medical_agent | Agent + Tools | A2A ä»‹é¢ |
| (æ–°å¢ - Canvas) | sync_canvas_state | - | UI åŒæ­¥ |
| (æ–°å¢ - Canvas) | push_to_canvas | - | æ¨é€è¦–è¦ºåŒ– |
| (æ–°å¢ - Canvas) | request_user_input | - | è«‹æ±‚ç”¨æˆ¶äº’å‹• |

---

## é™„éŒ„ B: VS Code Extension è¦æ ¼

### B.1 Extension æ¶æ§‹

```
medvision-mcp-vscode/
â”œâ”€â”€ package.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ extension.ts           # Extension å…¥å£
â”‚   â”œâ”€â”€ mcpClient.ts           # MCP å®¢æˆ¶ç«¯
â”‚   â”œâ”€â”€ commands/
â”‚   â”‚   â”œâ”€â”€ openViewer.ts      # é–‹å•Ÿå½±åƒæª¢è¦–å™¨
â”‚   â”‚   â”œâ”€â”€ analyzeImage.ts    # åˆ†æå½±åƒå‘½ä»¤
â”‚   â”‚   â””â”€â”€ exportReport.ts    # åŒ¯å‡ºå ±å‘Š
â”‚   â””â”€â”€ webview/
â”‚       â”œâ”€â”€ App.tsx            # React App
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â”œâ”€â”€ ImageViewer.tsx
â”‚       â”‚   â”œâ”€â”€ Canvas.tsx     # Fabric.js ç•«æ¿
â”‚       â”‚   â”œâ”€â”€ Toolbar.tsx    # å·¥å…·åˆ—
â”‚       â”‚   â”œâ”€â”€ AnnotationList.tsx
â”‚       â”‚   â””â”€â”€ AnalysisPanel.tsx
â”‚       â”œâ”€â”€ hooks/
â”‚       â”‚   â”œâ”€â”€ useMCP.ts      # MCP èª¿ç”¨ hook
â”‚       â”‚   â”œâ”€â”€ useCanvas.ts   # Canvas æ“ä½œ hook
â”‚       â”‚   â””â”€â”€ useSession.ts  # Session ç‹€æ…‹ hook
â”‚       â””â”€â”€ utils/
â”‚           â””â”€â”€ websocket.ts   # WebSocket é€£æ¥
â”œâ”€â”€ webview-ui/                # æ‰“åŒ…å¾Œçš„ WebView UI
â”œâ”€â”€ tsconfig.json
â””â”€â”€ webpack.config.js
```

### B.2 package.json é…ç½®

```json
{
  "name": "medvision-mcp",
  "displayName": "MedVision MCP - Medical Image Analysis",
  "description": "AI-powered medical image analysis with interactive annotation",
  "version": "0.1.0",
  "publisher": "medvision-mcp",
  "engines": {
    "vscode": "^1.85.0"
  },
  "categories": ["Machine Learning", "Visualization"],
  "activationEvents": [
    "onCommand:medvision-mcp.openViewer",
    "onWebviewPanel:medvision-mcp.imageViewer"
  ],
  "main": "./out/extension.js",
  "contributes": {
    "commands": [
      {
        "command": "medvision-mcp.openViewer",
        "title": "Open Medical Image Viewer",
        "category": "MedVision MCP"
      },
      {
        "command": "medvision-mcp.analyzeImage",
        "title": "Analyze Medical Image",
        "category": "MedVision MCP"
      }
    ],
    "menus": {
      "explorer/context": [
        {
          "when": "resourceExtname =~ /\\.(png|jpg|jpeg|dcm|dicom)$/i",
          "command": "medvision-mcp.openViewer",
          "group": "medvision-mcp"
        }
      ]
    },
    "configuration": {
      "title": "MedVision MCP",
      "properties": {
        "medvision-mcp.serverUrl": {
          "type": "string",
          "default": "http://localhost:8000",
          "description": "MedVision MCP MCP Server URL"
        },
        "medvision-mcp.autoAnalyze": {
          "type": "boolean",
          "default": true,
          "description": "Automatically analyze images on open"
        }
      }
    }
  }
}
```

### B.3 WebView é€šè¨Šå”è­°

```typescript
// extension.ts â†’ webview
interface ExtensionToWebviewMessage {
  type: 'init' | 'update' | 'analysis_result' | 'error';
  payload: any;
}

// webview â†’ extension.ts
interface WebviewToExtensionMessage {
  type: 'ready' | 'analyze' | 'region_select' | 'annotate' | 'export';
  payload: any;
}

// ç¯„ä¾‹ï¼šå€åŸŸé¸æ“‡
const message: WebviewToExtensionMessage = {
  type: 'region_select',
  payload: {
    session_id: 'abc123',
    region: {
      type: 'bbox',
      coordinates: [100, 200, 300, 400]
    },
    question: 'é€™æ˜¯ä»€éº¼ï¼Ÿ',
    actions: ['describe', 'segment']
  }
};
```

---

## é™„éŒ„ C: SAM 3 æ•´åˆ

### C.1 SAM 3 åŠŸèƒ½

| åŠŸèƒ½ | èªªæ˜ | ç”¨é€” |
|:-----|:-----|:-----|
| Point Prompt | é»æ“Šåˆ†å‰² | å¿«é€Ÿé¸å–ç—…ç¶ |
| Box Prompt | æ¡†é¸åˆ†å‰² | ç²¾ç¢ºæ¡†é¸å€åŸŸ |
| Polygon Prompt | å¤šé‚Šå½¢åˆ†å‰² | ä¸è¦å‰‡å€åŸŸ |
| Mask Refinement | é®ç½©ç²¾ä¿® | é‚Šç·£ä¿®æ­£ |
| Multi-Mask Output | å¤šé®ç½©è¼¸å‡º | ä¸ç¢ºå®šå€åŸŸæä¾›é¸é … |

### C.2 API è¨­è¨ˆ

```python
class SAM3Segmentor:
    def __init__(self, model_path: str, device: str = "cuda"):
        self.model = load_sam3(model_path)
        self.device = device
    
    def segment_point(
        self, 
        image: np.ndarray, 
        points: List[Tuple[int, int]],
        labels: List[int] = None,  # 1=foreground, 0=background
        multimask: bool = True
    ) -> Dict:
        """é»æ“Šåˆ†å‰²"""
        return {
            "masks": [...],  # List of masks (if multimask)
            "scores": [...],  # Confidence scores
            "best_mask_idx": 0
        }
    
    def segment_box(
        self,
        image: np.ndarray,
        box: Tuple[int, int, int, int]  # x1, y1, x2, y2
    ) -> Dict:
        """æ¡†é¸åˆ†å‰²"""
        ...
    
    def segment_polygon(
        self,
        image: np.ndarray,
        points: List[Tuple[int, int]]
    ) -> Dict:
        """å¤šé‚Šå½¢åˆ†å‰²"""
        ...
    
    def refine_mask(
        self,
        image: np.ndarray,
        mask: np.ndarray,
        points: List[Tuple[int, int]],
        labels: List[int]
    ) -> Dict:
        """é®ç½©ç²¾ä¿®"""
        ...
```

---

## é™„éŒ„ D: éŒ¯èª¤ç¢¼

| ä»£ç¢¼ | HTTP | èªªæ˜ |
|:-----|:-----|:-----|
| `SESSION_NOT_FOUND` | 404 | Session ä¸å­˜åœ¨ |
| `SESSION_EXPIRED` | 410 | Session å·²éæœŸ |
| `IMAGE_NOT_FOUND` | 404 | å½±åƒä¸å­˜åœ¨ |
| `INVALID_REGION` | 400 | å€åŸŸåº§æ¨™ç„¡æ•ˆ |
| `INVALID_IMAGE_TYPE` | 400 | ä¸æ”¯æ´çš„å½±åƒé¡å‹ |
| `MODEL_LOAD_ERROR` | 500 | æ¨¡å‹è¼‰å…¥å¤±æ•— |
| `INFERENCE_ERROR` | 500 | æ¨ç†åŸ·è¡Œå¤±æ•— |
| `VLLM_UNAVAILABLE` | 503 | vLLM æœå‹™ä¸å¯ç”¨ |
| `OLLAMA_UNAVAILABLE` | 503 | Ollama æœå‹™ä¸å¯ç”¨ |
| `GPU_OOM` | 507 | GPU è¨˜æ†¶é«”ä¸è¶³ |
| `EXPORT_FAILED` | 500 | åŒ¯å‡ºå¤±æ•— |
| `DATABASE_ERROR` | 500 | è³‡æ–™åº«éŒ¯èª¤ |

---

## é™„éŒ„ E: æ•ˆèƒ½åŸºæº–

### E.1 ç›®æ¨™å»¶é²

| æ“ä½œ | ç›®æ¨™å»¶é² | å‚™è¨» |
|:-----|:---------|:-----|
| å½±åƒä¸Šå‚³ | < 500ms | ä¸å«åˆ†æ |
| åˆ†é¡ (DenseNet) | < 200ms | GPU |
| åµæ¸¬ (MAIRA-2) | < 1s | vLLM |
| åˆ†å‰² (PSPNet) | < 500ms | GPU |
| äº’å‹•åˆ†å‰² (SAM3) | < 300ms | GPU |
| VQA (CheXagent) | < 2s | vLLM |
| å ±å‘Šç”Ÿæˆ | < 2s | PyTorch |
| å®Œæ•´åˆ†æ (preset=full) | < 5s | ä¸¦è¡Œ |

### E.2 è¨˜æ†¶é«”éœ€æ±‚

| æ¨¡å‹ | VRAM | å‚™è¨» |
|:-----|:-----|:-----|
| DenseNet | ~500MB | |
| PSPNet | ~500MB | |
| SAM 3 (ViT-H) | ~2GB | |
| CheXagent-2-3B (AWQ) | ~2GB | é‡åŒ– |
| LLaVA-Med-7B (GPTQ) | ~4GB | é‡åŒ– |
| MAIRA-2 (8bit) | ~3GB | é‡åŒ– |
| **Total (ä½µè¡Œ)** | **~12GB** | å»ºè­° RTX 4090 / A100 |

---

## é™„éŒ„ F: å®‰å…¨è€ƒé‡

### F.1 è³‡æ–™å®‰å…¨

| é …ç›® | è™•ç†æ–¹å¼ |
|:-----|:---------|
| å½±åƒå„²å­˜ | æœ¬åœ°å„²å­˜ï¼Œä¸ä¸Šå‚³é›²ç«¯ |
| Session è³‡æ–™ | SQLite åŠ å¯† (optional) |
| API é€šè¨Š | HTTPS (ç”Ÿç”¢ç’°å¢ƒ) |
| æ—¥èªŒè¨˜éŒ„ | ä¸è¨˜éŒ„ PHI |

### F.2 å­˜å–æ§åˆ¶

```yaml
# å»ºè­°çš„å­˜å–æ§åˆ¶é…ç½®
security:
  # API Key èªè­‰ (ç°¡å–®å ´æ™¯)
  api_key:
    enabled: false
    keys: []
  
  # JWT èªè­‰ (å¤šç”¨æˆ¶å ´æ™¯)  
  jwt:
    enabled: false
    secret: ""
    expiry: 3600
  
  # CORS
  cors:
    allowed_origins:
      - "http://localhost:*"
      - "vscode-webview://*"
```

### F.3 é†«ç™‚åˆè¦æ³¨æ„äº‹é …

> âš ï¸ **é‡è¦æé†’**
> 
> MedVision MCP ç‚ºç ”ç©¶/æ•™è‚²ç”¨é€”è¨­è¨ˆï¼Œ**ä¸æ˜¯** FDA/CE èªè­‰çš„é†«ç™‚å™¨æã€‚
> 
> - ä¸æ‡‰ç”¨æ–¼è‡¨åºŠè¨ºæ–·æ±ºç­–
> - æ‰€æœ‰åˆ†æçµæœåƒ…ä¾›åƒè€ƒ
> - éƒ¨ç½²æ–¹é ˆè‡ªè¡Œç¢ºä¿ HIPAA/GDPR åˆè¦
> - å»ºè­°åœ¨éš”é›¢ç¶²è·¯ç’°å¢ƒä¸­éƒ¨ç½²

---

## é™„éŒ„ G: å®Œæ•´æ¨¡å‹åƒè€ƒ

### G.1 Radiology VLM è©³ç´°è³‡è¨Š

#### CheXagent-2-3b (StanfordAIMI)

```yaml
name: CheXagent-2-3b
source: StanfordAIMI
huggingface: StanfordAIMI/CheXagent-2-3b
params: 3B
license: Apache-2.0
capabilities:
  - Visual Question Answering
  - Report Generation
  - Structured Report Findings
  - Structured Report Impressions
variants:
  - CheXagent-2-3b-srrg-findings  # å°ˆç”¨ findings
  - CheXagent-2-3b-srrg-impression  # å°ˆç”¨ impression
stats:
  downloads_monthly: 1,990
  likes: 7
  updated: 2025-01
```

#### MAIRA-2 (Microsoft)

```yaml
name: MAIRA-2
source: Microsoft Research
huggingface: microsoft/maira-2
params: 7B
license: MIT
capabilities:
  - Grounded Report Generation (with bounding boxes)
  - Findings Generation
  - Phrase Grounding
components:
  image_encoder: RAD-DINO-MAIRA-2
  language_model: vicuna-7b-v1.5
input:
  - Frontal CXR (required)
  - Lateral CXR (optional)
  - Prior Study (optional)
  - Clinical Indication (optional)
output:
  - Findings text
  - Bounding box annotations (optional)
stats:
  downloads_monthly: 3,566
  likes: 68
  spaces_using: 19
```

#### LLaVA-Med-v1.5 (Microsoft)

```yaml
name: LLaVA-Med v1.5 Mistral 7B
source: Microsoft
huggingface: microsoft/llava-med-v1.5-mistral-7b
params: 8B
license: Apache-2.0
capabilities:
  - General Medical VQA
  - Multi-turn Conversation
  - Multi-modality Support
stats:
  downloads_monthly: 10,200
  likes: 117
  total_variants: 129
```

### G.2 Medical Image Encoders è©³ç´°è³‡è¨Š

#### BiomedCLIP (Microsoft)

```yaml
name: BiomedCLIP-PubMedBERT_256-vit_base_patch16_224
source: Microsoft Health Futures
huggingface: microsoft/BiomedCLIP-PubMedBERT_256-vit_base_patch16_224
license: MIT
training_data: PMC-15M (15M figure-caption pairs from PubMed Central)
capabilities:
  - Zero-shot Image Classification
  - Cross-modal Retrieval
  - Image-Text Matching
architecture:
  text_encoder: PubMedBERT (context_length=256)
  image_encoder: ViT-B/16
supported_modalities:
  - Chest X-ray
  - Brain MRI
  - Bone X-ray
  - Histopathology (adenocarcinoma, SCC, H&E, IHC)
  - Medical Charts
stats:
  downloads_monthly: 713,607
  likes: 382
  spaces_using: 47
paper: "A Multimodal Biomedical Foundation Model Trained from Fifteen Million Imageâ€“Text Pairs" (NEJM AI 2024)
```

#### RAD-DINO (Microsoft)

```yaml
name: RAD-DINO
source: Microsoft Health Futures
huggingface: microsoft/rad-dino
license: MIT
params: 86.6M
training_data:
  total_images: 882,775
  sources:
    - MIMIC-CXR: 368,960
    - CheXpert: 223,648
    - NIH-CXR: 112,120
    - PadChest: 136,787
    - BRAX: 41,260
architecture:
  base_model: dinov2-base (facebook/dinov2-base)
  method: DINOv2 self-supervised learning
capabilities:
  - CXR Feature Extraction
  - Image Classification (with linear probe)
  - Image Segmentation (with decoder)
  - Image Retrieval
  - Foundation for Report Generation
stats:
  downloads_monthly: 60,345
  likes: 69
paper: "Exploring Scalable Medical Image Encoders Beyond Text Supervision" (Nature Machine Intelligence 2025)
```

### G.3 CT/MRI Segmentation è©³ç´°è³‡è¨Š

#### TotalSegmentator

```yaml
name: TotalSegmentator
source: University Hospital Basel
github: wasserth/TotalSegmentator
license: Apache-2.0
version: 2.5.0
classes:
  ct_total: 117 anatomical structures
  mr_total: 50 anatomical structures
tasks:
  open_source:
    - total (117 classes CT)
    - total_mr (50 classes MR)
    - lung_vessels
    - body / body_mr
    - vertebrae_mr
    - cerebral_bleed
    - pleural_pericard_effusion
    - head_glands_cavities
    - liver_vessels
    - lung_nodules
    - kidney_cysts
    - liver_segments / liver_segments_mr
    - trunk_cavities
  licensed:
    - heartchambers_highres
    - appendicular_bones
    - tissue_types
    - brain_structures
    - coronary_arteries
installation: pip install TotalSegmentator
usage: TotalSegmentator -i ct.nii.gz -o segmentations
requirements:
  - Python >= 3.9
  - PyTorch >= 2.0.0
  - GPU recommended (CPU supported with --fast)
stats:
  github_stars: 2,400
  forks: 395
  used_by: 109 projects
paper: "TotalSegmentator: Robust Segmentation of 104 Anatomic Structures in CT Images" (Radiology AI 2023)
```

### G.4 Pathology Foundation Models è©³ç´°è³‡è¨Š

#### Prov-GigaPath (Microsoft)

```yaml
name: Prov-GigaPath
source: Microsoft / Providence
huggingface: prov-gigapath/prov-gigapath
license: Apache-2.0
architecture:
  tile_encoder: DINOv2-based
  slide_encoder: 12-layer, 768-dim
capabilities:
  - Tile-level Feature Extraction
  - Slide-level Representation (with coordinates)
  - Linear Probing (PCam, PANDA)
training_data: Real-world WSI from Providence Health
input:
  tile_size: 224x224
  image_format: PNG, JPEG
output:
  tile_embedding: 1536-dim
  slide_embedding: 768-dim
stats:
  downloads_monthly: 328,518
  likes: 157
paper: "A whole-slide foundation model for digital pathology from real-world data" (Nature 2024)
```

#### UNI2-h (MahmoodLab)

```yaml
name: UNI 2 (UNI2-h)
source: Mahmood Lab @ Harvard/BWH
huggingface: MahmoodLab/UNI2-h
license: CC-BY-NC-ND-4.0 (Academic Only)
params: 681M
architecture:
  type: Custom ViT-H
  img_size: 224
  patch_size: 14
  embed_dim: 1536
  num_heads: 24
  depth: 24
  mlp: SwiGLU
  reg_tokens: 8
training_data:
  images: 200M+ tiles
  slides: 350k+ H&E and IHC slides
  source: Mass General Brigham
method: DINOv2 SSL (DINO + iBOT + KoLeo)
capabilities:
  - ROI Classification (linear probe, kNN, SimpleShot)
  - ROI Retrieval
  - Slide Classification (MIL)
  - Dense Prediction (with fine-tuning)
pre_extracted_features:
  available: TCGA, CPTAC, PANDA
stats:
  downloads_monthly: 44,393
  likes: 88
paper: "Towards a General-Purpose Foundation Model for Computational Pathology" (Nature Medicine 2024)
```

#### CONCH (MahmoodLab)

```yaml
name: CONCH
source: Mahmood Lab @ Harvard/BWH
huggingface: MahmoodLab/CONCH
license: CC-BY-NC-ND-4.0 (Academic Only)
architecture:
  vision_encoder: ViT-B/16 (90M params)
  text_encoder: L12-E768-H12 (110M params)
  # Decoder removed from public release
training_data:
  pairs: 1.17M image-caption pairs
  sources: PMC-OA + Internal
  stains: H&E, IHC, Special stains
method: CoCa (Contrastive + Captioning)
capabilities:
  - Zero-shot ROI Classification
  - Zero-shot WSI Classification (MI-Zero)
  - Image-Text Retrieval
  - ROI Classification (linear probe, fine-tune)
  - WSI Classification (MIL)
advantages:
  - Works on IHC and special stains (not just H&E)
  - No contamination from TCGA/PAIP/GTEX
stats:
  downloads_monthly: 17,240
  likes: 147
paper: "A visual-language foundation model for computational pathology" (Nature Medicine 2024)
```

### G.5 Interactive Segmentation è©³ç´°è³‡è¨Š

#### Medical-SAM3

```yaml
name: Medical-SAM3
source: AIM Research Lab / ChongCong
github: AIM-Research-Lab/Medical-SAM3
huggingface: ChongCong/Medical-SAM3
training_data:
  datasets: 33 medical imaging datasets
  modalities: 10 (CT, MRI, X-ray, Ultrasound, etc.)
capabilities:
  - Point-prompt Segmentation
  - Box-prompt Segmentation
  - Text-prompt Segmentation (open-vocabulary)
  - Mask Refinement
  - Multi-object Tracking
advantages:
  - Optimized for medical imaging
  - Better edge precision
  - Supports text descriptions
paper: arXiv:2601.10880
```

#### SAM 3 (Meta)

```yaml
name: Segment Anything 3 (SAM 3)
source: Meta AI / Facebook Research
github: facebookresearch/sam3
huggingface: facebook/sam3
params: 848M
license: Apache-2.0
requirements:
  python: ">=3.12"
  pytorch: ">=2.7"
  cuda: ">=12.6"
training_data:
  images: 11M
  masks: 1.1B
capabilities:
  - Point-prompt Segmentation
  - Box-prompt Segmentation
  - Text-prompt Segmentation
  - Video Segmentation (SAM-V)
  - Multi-mask Output
stats:
  github_stars: 7,400
  downloads_monthly: 1,650,000
```

---

## é™„éŒ„ H: æ¨¡å‹éœ€æ±‚æ‘˜è¦

### H.1 VRAM éœ€æ±‚

| æ¨¡å‹ | VRAM | é‡åŒ–å¾Œ | å‚™è¨» |
|:-----|:-----|:-------|:-----|
| DenseNet | ~500MB | - | PyTorch |
| PSPNet | ~500MB | - | PyTorch |
| SAM 3 (ViT-H) | ~2GB | - | PyTorch |
| Medical-SAM3 | ~2GB | - | PyTorch |
| CheXagent-2-3B | ~6GB | ~2GB (AWQ) | vLLM |
| LLaVA-Med-8B | ~16GB | ~4GB (GPTQ) | vLLM |
| MAIRA-2 (7B) | ~14GB | ~3GB (8bit) | vLLM |
| BiomedCLIP | ~1GB | - | PyTorch/OpenCLIP |
| RAD-DINO | ~500MB | - | PyTorch |
| TotalSegmentator | ~4GB | - | nnUNet |
| Prov-GigaPath | ~2GB | - | timm |
| UNI2-h | ~3GB | - | timm |
| CONCH | ~1GB | - | OpenCLIP |

### H.2 å»ºè­°é…ç½®

| é…ç½® | GPU | å¯åŒæ™‚è¼‰å…¥ |
|:-----|:----|:-----------|
| **æœ€ä½** | RTX 3060 (12GB) | 1 VLM + SAM + Encoder |
| **æ¨è–¦** | RTX 4090 (24GB) | 2 VLM + SAM + å¤š Encoder |
| **ç”Ÿç”¢** | A100 (80GB) | å…¨æ¨¡å‹ + é«˜ä½µç™¼ |

### H.3 æ¨¡å‹å„ªå…ˆé †åº

```
Phase 1 (MVP):
â”œâ”€â”€ CheXagent-2-3b     # CXR VQA & Report
â”œâ”€â”€ Medical-SAM3       # Interactive Segmentation
â”œâ”€â”€ RAD-DINO           # Feature Extraction
â””â”€â”€ BiomedCLIP         # Zero-shot Classification

Phase 2 (æ“´å±•):
â”œâ”€â”€ MAIRA-2            # Grounded Reports
â”œâ”€â”€ LLaVA-Med          # Multi-modality VQA
â”œâ”€â”€ TotalSegmentator   # CT/MRI Anatomy
â””â”€â”€ DenseNet/PSPNet    # Legacy compatibility

Phase 3 (ç—…ç†):
â”œâ”€â”€ Prov-GigaPath      # WSI Encoding
â”œâ”€â”€ CONCH              # Zero-shot Pathology
â””â”€â”€ UNI2-h             # High-accuracy Tiles
```

### H.4 å·²é©—è­‰æ¨¡å‹ç‹€æ…‹ (2026-02 å¯¦æ¸¬)

> **æ¸¬è©¦ç’°å¢ƒ**ï¼šTesla V100-SXM2-32GB, Python 3.12, PyTorch 2.9, CUDA 12.8

| æ¨¡å‹ | ç‹€æ…‹ | å·¥å…·é¡åˆ¥ | èªªæ˜ |
|:-----|:-----|:---------|:-----|
| **RAD-DINO** | âœ… Ready | Visual RAG | microsoft/rad-dino, 346MB, 768-dim embedding |
| **FAISS** | âœ… Ready | Visual RAG | faiss-cpu, å‘é‡æª¢ç´¢ï¼ŒL2 è·é›¢ |
| **DenseNet-121** | âœ… Ready | åˆ†é¡ | torchxrayvisionï¼Œ18 ç¨® CXR ç—…ç† |
| **PSPNet** | âœ… Ready | åˆ†å‰² | torchxrayvisionï¼Œ14 ç¨®å™¨å®˜åˆ†å‰² |
| **DICOM Processor** | âœ… Ready | å½±åƒè™•ç† | pydicomï¼ŒWindow/Level èª¿æ•´ |
| **ViT-BERT Report Generator** | âœ… Ready | å ±å‘Šç”Ÿæˆ | IAMJB/radiology_report_generationï¼Œå·²ä¸‹è¼‰æ¬Šé‡ |
| **Ollama** | âœ… Ready | LLM æœå‹™ | v0.15.4ï¼Œllava:7b å·²ä¸‹è¼‰ï¼ŒGPU æ¨¡å¼ |
| **CheXagent-2-3b VQA** | âš ï¸ ä¸‹è¼‰æ…¢ | VQA | HuggingFace ä¸‹è¼‰é€Ÿåº¦ä¸è¶³ï¼Œå»ºè­°ç”¨ Ollama æ›¿ä»£ |
| **LLaVA-Med-1.5-7B** | â“ æœªæ¸¬è©¦ | VQA | éœ€ vLLM æœå‹™æˆ–ç›´æ¥è¼‰å…¥ |
| **MAIRA-2** | â“ æœªæ¸¬è©¦ | Grounding | Microsoft Phrase Grounding |
| **Roentgen** | â“ æœªæ¸¬è©¦ | ç”Ÿæˆ | éœ€æœ¬åœ° Roentgen æ¬Šé‡ |

**Visual RAG æ··åˆæ¨¡å¼ (Mode B) å·²é©—è­‰å¯ç”¨**ï¼š
- RAD-DINO ç·¨ç¢¼ï¼š~2ç§’/å¼µ (GPU)
- FAISS æª¢ç´¢ï¼š<1ms (4 å¼µ demo)
- å»ºè­°ç”¨æ–¼å¿«é€ŸåŸå‹é–‹ç™¼

---

## é™„éŒ„ I: MedVision MCP Agent è¦æ ¼

### I.1 Agent æ¦‚è¿°

MedVision MCP Agent æ˜¯ä¸€å€‹å…§å»ºçš„é†«ç™‚å½±åƒåˆ†æ Agentï¼Œè¨­è¨ˆç‚ºï¼š
- **å°å…§**ï¼šä½¿ç”¨ MCP Tools åŸ·è¡Œåˆ†æä»»å‹™
- **å°å¤–**ï¼šä½œç‚º MCP Tool ä¾›å¤–éƒ¨ Agent å§”è¨—ï¼ˆA2Aï¼‰

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         MedVision MCP Agent æ¶æ§‹                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                      Agent Core (LangGraph ReAct)                   â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚   Planner     â”‚  â”‚   Executor    â”‚  â”‚   Memory              â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   â”€â”€â”€â”€â”€â”€â”€     â”‚  â”‚   â”€â”€â”€â”€â”€â”€â”€â”€    â”‚  â”‚   â”€â”€â”€â”€â”€â”€              â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   ä»»å‹™åˆ†è§£     â”‚  â”‚   å·¥å…·èª¿ç”¨    â”‚  â”‚   å°è©±æ­·å²            â”‚   â”‚   â”‚
â”‚   â”‚   â”‚   æµç¨‹ç·¨æ’     â”‚  â”‚   çµæœè™•ç†    â”‚  â”‚   åˆ†æä¸Šä¸‹æ–‡          â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                    â”‚ Internal MCP Calls                     â”‚
â”‚                                    â–¼                                        â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚                     MCP Tools Invocation                            â”‚   â”‚
â”‚   â”‚   analyze_image | analyze_selected_region | ask_about_image | ...   â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### I.2 Agent èƒ½åŠ›

| èƒ½åŠ› | èªªæ˜ | å°æ‡‰ MCP Tools |
|:-----|:-----|:---------------|
| **å½±åƒç†è§£** | ç†è§£é†«ç™‚å½±åƒå…§å®¹å’Œèªç¾© | `analyze_image`, `ask_about_image` |
| **ç•°å¸¸åµæ¸¬** | è‡ªå‹•è­˜åˆ¥ä¸¦æ¨™è¨»ç•°å¸¸å€åŸŸ | `analyze_image(detect=True)` |
| **å€åŸŸåˆ†æ** | æ·±å…¥åˆ†æç”¨æˆ¶é¸å®šå€åŸŸ | `analyze_selected_region` |
| **å ±å‘Šç”Ÿæˆ** | ç”Ÿæˆçµæ§‹åŒ–åˆ†æå ±å‘Š | `analyze_image(generate_report=True)` |
| **äº’å‹•åˆ†å‰²** | æ ¹æ“šæç¤ºé€²è¡Œç²¾ç¢ºåˆ†å‰² | `analyze_selected_region(actions=["segment"])` |
| **å¤šè¼ªå°è©±** | ç¶­æŒä¸Šä¸‹æ–‡çš„é€£çºŒå°è©± | Agent Memory |
| **æµç¨‹ç·¨æ’** | æ ¹æ“šä»»å‹™è‡ªå‹•ç·¨æ’åˆ†ææµç¨‹ | Planner |

### I.3 A2A (Agent-to-Agent) ä»‹é¢

å¤–éƒ¨ Agentï¼ˆå¦‚ Claudeã€GPTï¼‰å¯ä»¥é€é `invoke_medical_agent` å·¥å…·å§”è¨— MedVision MCP Agentï¼š

```python
# å¤–éƒ¨ Agent çš„èª¿ç”¨ç¯„ä¾‹
result = await mcp_client.call_tool("invoke_medical_agent", {
    "session_id": "abc123",
    "task": "åˆ†æé€™å¼µ CXRï¼Œç‰¹åˆ¥æ³¨æ„ç”¨æˆ¶æ¨™è¨˜çš„å³è‚ºå€åŸŸ",
    "context": {
        "user_selection": {
            "type": "bbox",
            "coordinates": [100, 200, 300, 400]
        },
        "clinical_history": "æ‚£è€…æœ‰å’³å—½ç—‡ç‹€"
    },
    "mode": "auto"
})

# è¿”å›çµæœ
{
    "status": "completed",
    "result": {
        "summary": "åœ¨å³è‚ºç™¼ç¾ä¸€å€‹ 2.3cm çš„çµç¯€...",
        "findings": [...],
        "annotations": [...],
        "report": "..."
    },
    "actions_taken": [
        "analyze_image(classify=True)",
        "analyze_selected_region(actions=['describe', 'segment'])",
        "ask_about_image('é€™å€‹çµç¯€çš„ç‰¹å¾µæ˜¯ä»€éº¼ï¼Ÿ')"
    ],
    "follow_up_suggestions": [
        "å»ºè­°é€²è¡Œ CT æƒæé€²ä¸€æ­¥ç¢ºèª",
        "å¯ä»¥æ¯”è¼ƒå…ˆå‰çš„å½±åƒè§€å¯Ÿè®ŠåŒ–"
    ]
}
```

### I.4 èˆ‡ Canvas UI äº’å‹•

Agent å¯ä»¥ä¸»å‹•èˆ‡ Canvas UI äº’å‹•ï¼š

```python
# Agent åœ¨ Canvas ä¸Šé«˜äº®å€åŸŸ
await mcp_client.call_tool("push_to_canvas", {
    "session_id": "abc123",
    "action": "highlight",
    "payload": {
        "region": {"type": "bbox", "coordinates": [100, 200, 300, 400]},
        "style": "pulse",
        "label": "å¯ç–‘å€åŸŸ"
    }
})

# Agent è«‹æ±‚ç”¨æˆ¶ç¢ºèª
result = await mcp_client.call_tool("request_user_input", {
    "session_id": "abc123",
    "input_type": "confirm",
    "prompt": "é€™å€‹å€åŸŸçœ‹èµ·ä¾†åƒçµç¯€ï¼Œæ˜¯å¦éœ€è¦è©³ç´°åˆ†æï¼Ÿ"
})
```

### I.5 Agent é…ç½®

```yaml
# agent_config.yaml
agent:
  # Agent åº•å±¤æ¨¡å‹
  llm:
    provider: "ollama"  # or "vllm", "openai", "anthropic"
    model: "llama3:70b"  # ä¸»æ¨ç†æ¨¡å‹
    fallback: "llama3:8b"  # å‚™æ´æ¨¡å‹
  
  # æ¨ç†è¨­å®š
  inference:
    temperature: 0.1
    max_tokens: 2048
    retry_attempts: 3
  
  # è¨˜æ†¶è¨­å®š
  memory:
    type: "buffer"  # buffer, summary, vector
    max_turns: 20
    persist: true
  
  # å¯ç”¨å·¥å…·
  tools:
    enabled:
      - "analyze_image"
      - "analyze_selected_region"
      - "ask_about_image"
      - "add_annotation"
      - "push_to_canvas"
      - "request_user_input"
    
  # è¡Œç‚ºè¨­å®š
  behavior:
    auto_explain: true  # è‡ªå‹•è§£é‡‹åˆ†æçµæœ
    suggest_next_steps: true  # å»ºè­°å¾ŒçºŒå‹•ä½œ
    interactive_mode: true  # éœ€è¦æ™‚è©¢å•ç”¨æˆ¶
```

### I.6 äº’å‹•è¨ºæ–·æµç¨‹è¨­è¨ˆ

#### I.6.1 é›™å‘äº’å‹•è¨ºæ–·å¾ªç’°

MedVision MCP çš„æ ¸å¿ƒäº’å‹•æ¨¡å¼æ˜¯ä¸€å€‹**é›™å‘äº’å‹•è¨ºæ–·å¾ªç’° (Diagnosis Loop)**ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     äº’å‹•è¨ºæ–·å¾ªç’° (Diagnosis Loop)                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚   â”‚   Canvas    â”‚â—„â”€â”€â”€â”€â”€â”€ push_to_canvas â”€â”€â”€â”€â”€â”€â”€â”‚   Agent     â”‚          â”‚
â”‚   â”‚   (ç•«æ¿)    â”‚                              â”‚   (è¨ºæ–·)    â”‚          â”‚
â”‚   â”‚             â”‚                              â”‚             â”‚          â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚   user_region_select         â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚   â”‚  â”‚å½±åƒ   â”‚  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚  â”‚VLM    â”‚  â”‚          â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                              â”‚  â”‚Agent  â”‚  â”‚          â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚   agent_highlight            â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚   â”‚  â”‚æ¨™è¨˜   â”‚â—„â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤             â”‚          â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚                              â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚          â”‚
â”‚   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”  â”‚                              â”‚  â”‚Tools  â”‚  â”‚          â”‚
â”‚   â”‚  â”‚ç”¨æˆ¶ç•« â”‚  â”‚   ask_about_region           â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚          â”‚
â”‚   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚             â”‚          â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚         â–²                                            â”‚                  â”‚
â”‚         â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”               â”‚                  â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚  å°è©±æ¡†/Chat â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### I.6.2 äº’å‹•æ­¥é©Ÿè©³è§£

| æ­¥é©Ÿ | ç™¼èµ·è€… | å‹•ä½œ | æŠ€è¡“å¯¦ç¾ |
|:-----|:-------|:-----|:---------|
| 1 | User | è¼‰å…¥å½±åƒåˆ° Canvas | `add_image_to_session` |
| 2 | User | åœ¨å°è©±æ¡†å•è¨ºæ–· | `invoke_medical_agent` / handoff |
| 3 | Agent | å›ç­”è¨ºæ–·çµæœ | VLM inference |
| 4 | User | è¦æ±‚æ¨™è¨˜å‡ºç™¼ç¾ä½ç½® | `request: "highlight findings"` |
| 5 | Agent | **ä¸»å‹•**åœ¨ Canvas æ¨™è¨˜ | `push_to_canvas` |
| 6 | User | **åœ¨ Canvas åœˆé¸å€åŸŸ** å• "é€™è£¡å‘¢ï¼Ÿ" | `user_region_select` â†’ MCP call |
| 7 | Agent | åˆ†æç”¨æˆ¶é¸å€ + **ä¸»å‹•æ¨™å‡ºç›¸é—œå€åŸŸ** | `analyze_selected_region` + `push_to_canvas` |

#### I.6.3 å®Œæ•´æµç¨‹ç¯„ä¾‹

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 äº’å‹•è¨ºæ–·æµç¨‹ (å®Œæ•´ç¯„ä¾‹)                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚  Step 1: è¼‰å…¥å½±åƒ                                                        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚  User æ‹‰å…¥   â”‚ â”€â”€â–º add_image_to_session â”€â”€â–º Canvas é¡¯ç¤ºå½±åƒ           â”‚
â”‚  â”‚  CXR å½±åƒ   â”‚                                                        â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚                                                                         â”‚
â”‚  Step 2: å•è¨ºæ–·                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚  User è¼¸å…¥   â”‚ â”€â”€â–º invoke_medical_agent({                            â”‚
â”‚  â”‚  "å¹«æˆ‘è¨ºæ–·"  â”‚       task: "è¨ºæ–·é€™å¼µå½±åƒ",                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       config: {auto_suggest: true}                     â”‚
â”‚                      })                                                 â”‚
â”‚                                                                         â”‚
â”‚  Step 3: Agent å›ç­” + è‡ªå‹•æ¨™è¨˜                                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Agent:     â”‚     â”‚ push_to_canvas({                            â”‚    â”‚
â”‚  â”‚  "å³ä¸‹è‚ºæœ‰  â”‚ â”€â”€â–º â”‚   annotations: [                            â”‚    â”‚
â”‚  â”‚   çµç¯€"     â”‚     â”‚     {type: "bbox", coords: [...], label: ..}â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   ],                                        â”‚    â”‚
â”‚         â”‚            â”‚   related_regions: [                        â”‚    â”‚
â”‚         â–¼            â”‚     {coords: [...], note: "å»ºè­°ä¹Ÿæª¢æŸ¥é€™è£¡"} â”‚    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚   ]                                         â”‚    â”‚
â”‚  â”‚ Canvas é¡¯ç¤º â”‚     â”‚ })                                          â”‚    â”‚
â”‚  â”‚ æ¨™è¨˜+å»ºè­°   â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                        â”‚
â”‚                                                                         â”‚
â”‚  Step 4: User åœ¨ Canvas ç•«å€åŸŸå• "é€™è£¡å‘¢ï¼Ÿ"                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                        â”‚
â”‚  â”‚ User Draws  â”‚ â”€â”€â–º analyze_selected_region({                          â”‚
â”‚  â”‚ Freehand    â”‚       region: {type: "polygon", points: [...]},        â”‚
â”‚  â”‚ "é€™è£¡å‘¢ï¼Ÿ"  â”‚       question: "é€™è£¡å‘¢ï¼Ÿ",                             â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       actions: ["describe", "segment", "suggest"]      â”‚
â”‚                      })                                                 â”‚
â”‚                                                                         â”‚
â”‚  Step 5: Agent å›ç­” + æ¨™å‡ºç›¸é—œå€åŸŸ                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Agent:     â”‚     â”‚ Response includes:                          â”‚    â”‚
â”‚  â”‚  "é€™å€åŸŸæ˜¯  â”‚ â”€â”€â–º â”‚   answer: "é€™æ˜¯è‚ºç´‹ç†å¢åŠ å€åŸŸ..."           â”‚    â”‚
â”‚  â”‚   è‚ºç´‹ç†... â”‚     â”‚   annotations: [                            â”‚    â”‚
â”‚  â”‚   å¦å¤–é€™å€  â”‚     â”‚     {type:"mask", data:[...], label:"ç”¨æˆ¶"}â”‚    â”‚
â”‚  â”‚   åŸŸä¹Ÿæœ‰..."â”‚     â”‚   ],                                        â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚   related_suggestions: [                    â”‚    â”‚
â”‚                      â”‚     {coords:[...], note:"é€™è£¡å¯èƒ½ä¹Ÿæœ‰æµ¸æ½¤"} â”‚    â”‚
â”‚                      â”‚   ]                                         â”‚    â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### I.6.4 ä¸»å‹•å»ºè­°é…ç½®

Agent ä¸»å‹•æ¨™è¨˜ã€Œé€™è£¡å¯èƒ½ä¹Ÿæœ‰å•é¡Œã€çš„è§¸ç™¼æ™‚æ©Ÿå¯é…ç½®ï¼š

```yaml
# agent_config.yaml
behavior:
  auto_suggest:
    enabled: true  # å¯é—œé–‰
    triggers:
      - on_analysis_complete      # åˆ†æå®Œæˆè‡ªå‹•å»ºè­°
      - on_user_region_question   # ç”¨æˆ¶å•å€åŸŸæ™‚é †ä¾¿å»ºè­°
      - on_high_confidence_finding  # é«˜ä¿¡å¿ƒç™¼ç¾æ™‚å»ºè­°
    min_confidence: 0.7  # ä¿¡å¿ƒåº¦é–€æª»
    max_suggestions: 3   # æœ€å¤šå»ºè­°æ•¸é‡
```

---

### I.7 UI æ¶æ§‹ (å…±ç”¨çµ„ä»¶ç­–ç•¥)

Canvas UI æ¡ç”¨**å…±ç”¨ React çµ„ä»¶åº«**ç­–ç•¥ï¼Œæ”¯æ´å¤šå¹³å°éƒ¨ç½²ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        UI æ¶æ§‹ (å…±ç”¨çµ„ä»¶åº«)                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚   â”‚              @medvision-mcp/canvas (npm package)                â”‚   â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚
â”‚   â”‚   â”‚ ImageView â”‚ â”‚ AnnotateTool â”‚ â”‚ ZoomPanCtl â”‚ â”‚ LayerMgr  â”‚   â”‚   â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚   â”‚
â”‚   â”‚   React + Fabric.js + TypeScript                                â”‚   â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                  â”‚                                      â”‚
â”‚          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚          â–¼                       â–¼                       â–¼              â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚   â”‚ VS Code Ext  â”‚       â”‚ Standalone Web   â”‚    â”‚ Electron (opt) â”‚     â”‚
â”‚   â”‚ (WebView)    â”‚       â”‚ (Vite/Next.js)   â”‚    â”‚ (future)       â”‚     â”‚
â”‚   â”‚              â”‚       â”‚                  â”‚    â”‚                â”‚     â”‚
â”‚   â”‚ é–‹ç™¼/æ¸¬è©¦ç”¨   â”‚       â”‚ æœ€çµ‚ç”¢å“éƒ¨ç½²      â”‚    â”‚ é›¢ç·šéƒ¨ç½²é¸é …   â”‚     â”‚
â”‚   â”‚ Copilotæ•´åˆ  â”‚       â”‚                  â”‚    â”‚                â”‚     â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### I.7.1 çµ„ä»¶åº«çµæ§‹

```
@medvision-mcp/canvas/
â”œâ”€â”€ package.json
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ index.ts                # å…¬é–‹ API
â”‚   â”œâ”€â”€ components/
â”‚   â”‚   â”œâ”€â”€ MedicalCanvas.tsx   # ä¸»ç•«å¸ƒçµ„ä»¶
â”‚   â”‚   â”œâ”€â”€ ImageViewer.tsx     # DICOM/PNG é¡¯ç¤º
â”‚   â”‚   â”œâ”€â”€ AnnotationLayer.tsx # æ¨™è¨˜åœ–å±¤
â”‚   â”‚   â”œâ”€â”€ ToolPalette.tsx     # å·¥å…·é¸æ¿
â”‚   â”‚   â”œâ”€â”€ LayerPanel.tsx      # åœ–å±¤ç®¡ç†
â”‚   â”‚   â””â”€â”€ MiniMap.tsx         # ç¸®åœ–å°èˆª
â”‚   â”œâ”€â”€ hooks/
â”‚   â”‚   â”œâ”€â”€ useMCP.ts           # MCP é€šè¨Š hook
â”‚   â”‚   â”œâ”€â”€ useCanvas.ts        # Canvas æ“ä½œ hook
â”‚   â”‚   â”œâ”€â”€ useAnnotations.ts   # æ¨™è¨˜ç®¡ç† hook
â”‚   â”‚   â””â”€â”€ useSession.ts       # Session ç‹€æ…‹ hook
â”‚   â”œâ”€â”€ types/
â”‚   â”‚   â””â”€â”€ annotations.ts      # TypeScript å®šç¾©
â”‚   â””â”€â”€ utils/
â”‚       â”œâ”€â”€ fabricHelpers.ts    # Fabric.js å·¥å…·
â”‚       â””â”€â”€ dicomLoader.ts      # DICOM è¼‰å…¥
â”œâ”€â”€ dist/                       # æ‰“åŒ…è¼¸å‡º
â””â”€â”€ README.md
```

---

### I.8 Canvas æ¨™è¨˜é¡å‹å®šç¾©

#### I.8.1 æ”¯æ´çš„æ¨™è¨˜é¡å‹

| é¡å‹ | ç”¨é€” | ç”¨æˆ¶å¯ç•« | Agent å¯ç”Ÿæˆ |
|:-----|:-----|:---------|:-------------|
| `bbox` | çŸ©å½¢æ¡†é¸ | âœ… | âœ… |
| `polygon` | å¤šé‚Šå½¢è¼ªå»“ | âœ… | âœ… |
| `freehand` | æ‰‹ç¹ªç·šæ¢ | âœ… | âŒ |
| `mask` | åˆ†å‰²é®ç½© (SAM3) | âŒ | âœ… |
| `point` | é»æ¨™è¨˜ | âœ… | âœ… |
| `text` | æ–‡å­—æ¨™è¨» | âœ… | âœ… |

#### I.8.2 TypeScript å®šç¾©

```typescript
// @medvision-mcp/canvas/src/types/annotations.ts

type AnnotationType = 
  | 'bbox'          // çŸ©å½¢æ¡†
  | 'polygon'       // å¤šé‚Šå½¢è¼ªå»“
  | 'freehand'      // æ‰‹ç¹ªç·šæ¢
  | 'mask'          // åˆ†å‰²é®ç½© (from SAM3)
  | 'point'         // é»æ¨™è¨˜
  | 'text';         // æ–‡å­—æ¨™è¨»

type AnnotationSource = 'user' | 'agent';

interface AnnotationStyle {
  color: string;        // e.g., "#FF0000"
  opacity: number;      // 0-1
  strokeWidth: number;  // pixels
  fill: boolean;        // æ˜¯å¦å¡«å……
  lineDash?: number[];  // è™›ç·šæ¨£å¼
}

interface Annotation {
  id: string;
  type: AnnotationType;
  source: AnnotationSource;
  timestamp: string;
  
  // å¹¾ä½•è³‡æ–™ (æ ¹æ“š type)
  coordinates?: [number, number, number, number];  // bbox: [x1, y1, x2, y2]
  points?: [number, number][];                     // polygon/freehand/point
  mask?: {
    data: string;       // base64 encoded binary mask
    width: number;
    height: number;
  };
  textContent?: string; // text é¡å‹çš„æ–‡å­—å…§å®¹
  textPosition?: [number, number];  // text ä½ç½®
  
  // æ¨™è¨»è³‡è¨Š
  label?: string;
  description?: string;
  confidence?: number;  // Agent æ¨™è¨˜çš„ä¿¡å¿ƒåº¦ (0-1)
  finding?: string;     // å°æ‡‰çš„è‡¨åºŠç™¼ç¾
  
  // é¡¯ç¤ºæ¨£å¼
  style: AnnotationStyle;
  
  // äº’å‹•ç‹€æ…‹
  visible: boolean;
  locked: boolean;
  interactive: boolean;  // é»æ“Šå¯å±•é–‹è©³æƒ…
  
  // é—œè¯
  relatedAnnotationIds?: string[];  // é—œè¯çš„å…¶ä»–æ¨™è¨˜
  suggestedBy?: string;  // ç”±èª°å»ºè­° (agent/user annotation id)
}

interface CanvasState {
  sessionId: string;
  imageId: string;
  annotations: Annotation[];
  selectedAnnotationId?: string;
  zoom: number;
  pan: { x: number; y: number };
  activeTool: 'select' | 'bbox' | 'polygon' | 'freehand' | 'point' | 'text';
}
```

#### I.8.3 Agent æ¨é€æ¨™è¨˜ç¯„ä¾‹

```python
# Agent åˆ†æå®Œæˆå¾Œæ¨é€æ¨™è¨˜åˆ° Canvas
await mcp_client.call_tool("push_to_canvas", {
    "session_id": "abc123",
    "action": "add_annotations",
    "payload": {
        "annotations": [
            {
                "id": "agent-finding-001",
                "type": "bbox",
                "source": "agent",
                "coordinates": [120, 80, 200, 160],
                "label": "å³è‚ºçµç¯€",
                "description": "ç´„ 1.2cm çš„å¯¦è³ªæ€§çµç¯€ï¼Œé‚Šç·£æ¸…æ¥š",
                "confidence": 0.92,
                "finding": "nodule",
                "style": {
                    "color": "#FF6B6B",
                    "opacity": 0.8,
                    "strokeWidth": 2,
                    "fill": False
                },
                "interactive": True
            },
            {
                "id": "agent-mask-001",
                "type": "mask",
                "source": "agent",
                "mask": {
                    "data": "base64...",  # SAM3 è¼¸å‡º
                    "width": 512,
                    "height": 512
                },
                "label": "çµç¯€ç²¾ç¢ºè¼ªå»“",
                "style": {
                    "color": "#FF6B6B",
                    "opacity": 0.4,
                    "strokeWidth": 0,
                    "fill": True
                }
            }
        ],
        "related_suggestions": [
            {
                "region": {"type": "bbox", "coordinates": [300, 200, 380, 280]},
                "note": "å»ºè­°ä¹Ÿæª¢æŸ¥é€™å€‹å€åŸŸï¼Œå¯èƒ½æœ‰ç›¸ä¼¼ç—…è®Š",
                "style": {
                    "color": "#FFE66D",
                    "opacity": 0.6,
                    "strokeWidth": 2,
                    "lineDash": [5, 5]
                }
            }
        ]
    }
})
```

---

### I.9 A2A vs ç´” MCP é›™æ¨¡å¼

MedVision MCP åŒæ™‚æ”¯æ´å…©ç¨®èª¿ç”¨æ¨¡å¼ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        é›™æ¨¡å¼æ¶æ§‹                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                         â”‚
â”‚   å¤–éƒ¨ Agent (Claude Opus / GPT)                                        â”‚
â”‚         â”‚                                                               â”‚
â”‚         â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ æ¨¡å¼ A: ç´” MCP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚
â”‚         â”‚            ç›´æ¥èª¿ç”¨å·¥å…·                          â–¼             â”‚
â”‚         â”‚       â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚         â”‚       â”‚    MCP Server (medvision-mcp)               â”‚         â”‚
â”‚         â”‚       â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚         â”‚
â”‚         â”‚       â”‚    â”‚analyze_ â”‚ask_     â”‚analyze_selected_â”‚  â”‚         â”‚
â”‚         â”‚       â”‚    â”‚image    â”‚about_   â”‚region           â”‚  â”‚         â”‚
â”‚         â–¼       â”‚    â”‚         â”‚image    â”‚                 â”‚  â”‚         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚â—„â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚         â”‚
â”‚  â”‚              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚  â”‚                                                                      â”‚
â”‚  â”‚              æ¨¡å¼ B: A2A (å§”è¨—)                                       â”‚
â”‚  â”‚              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚              â”‚  invoke_medical_agent                       â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚         â”‚
â”‚                 â”‚    â”‚ Internal Agent (LangGraph)          â”‚   â”‚         â”‚
â”‚                 â”‚    â”‚  - ä»»å‹™åˆ†è§£                          â”‚   â”‚         â”‚
â”‚                 â”‚    â”‚  - å‘¼å«å¤š tools                      â”‚   â”‚         â”‚
â”‚                 â”‚    â”‚  - å°è©±è¨˜æ†¶                          â”‚   â”‚         â”‚
â”‚                 â”‚    â”‚  - ä¸»å‹•å»ºè­°                          â”‚   â”‚         â”‚
â”‚                 â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚         â”‚
â”‚                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚                                                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### I.9.1 æ¨¡å¼é¸æ“‡æŒ‡å¼•

| å ´æ™¯ | æ¨è–¦æ¨¡å¼ | åŸå›  |
|:-----|:---------|:-----|
| å–®ä¸€å½±åƒå¿«é€Ÿåˆ†é¡ | ç´” MCP | å¤–éƒ¨ Agent ç›´æ¥èª¿ç”¨ `analyze_image` |
| å–®ä¸€å•ç­” | ç´” MCP | ç›´æ¥èª¿ç”¨ `ask_about_image` |
| å®Œæ•´è¨ºæ–·æµç¨‹ | A2A | éœ€è¦å¤šå·¥å…·ç·¨æ’å’Œä¸Šä¸‹æ–‡è¨˜æ†¶ |
| äº’å‹•å¼å€åŸŸæ¢ç´¢ | A2A | éœ€è¦è¨˜ä½å…ˆå‰çš„ç™¼ç¾å’Œå»ºè­° |
| æ‰¹é‡è™•ç†å¤šå¼µå½±åƒ | ç´” MCP | å¤–éƒ¨ Agent è‡ªè¡Œç·¨æ’è¿´åœˆ |
| èˆ‡ Canvas æ·±åº¦äº’å‹• | A2A | éœ€è¦ä¸»å‹•æ¨é€æ¨™è¨˜å’Œå»ºè­° |

#### I.9.2 handoff æ©Ÿåˆ¶

å¤–éƒ¨ Agentï¼ˆå¦‚ Claudeï¼‰å¯é€é handoff å°‡æ§åˆ¶æ¬Šè½‰ç§»çµ¦å…§å»º Agentï¼š

```python
# Claude ç™¼èµ· handoff
result = await mcp_client.call_tool("invoke_medical_agent", {
    "session_id": "abc123",
    "task": "å®Œæ•´åˆ†æé€™å¼µå½±åƒï¼Œä¸¦èˆ‡ç”¨æˆ¶äº’å‹•ç¢ºèªç™¼ç¾",
    "mode": "interactive",  # å•Ÿç”¨äº’å‹•æ¨¡å¼
    "handoff": {
        "return_on": ["user_confirmation", "analysis_complete"],
        "max_turns": 10,
        "preserve_context": True
    }
})

# Internal Agent æ¥ç®¡å¾Œï¼š
# 1. åŸ·è¡Œåˆ†æ
# 2. æ¨é€æ¨™è¨˜åˆ° Canvas
# 3. ç­‰å¾…ç”¨æˆ¶å›æ‡‰
# 4. ç¹¼çºŒå°è©±
# 5. å®Œæˆå¾Œè¿”å›æ§åˆ¶æ¬Šçµ¦ Claude
```

---

### I.10 Visual RAG Ã— Canvas æ•´åˆ

> **æ ¸å¿ƒæ©Ÿåˆ¶**ï¼šç”¨æˆ¶åœ¨ Canvas åœˆé¸å€åŸŸ â†’ è§¸ç™¼ Visual RAG â†’ è¿”å›ç›¸ä¼¼æ¡ˆä¾‹ â†’ å¤–éƒ¨ Agent ç¶œåˆåˆ¤æ–· â†’ æ¨é€æ¨™è¨˜å› Canvas

#### I.10.1 å®Œæ•´è³‡æ–™æµ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Visual RAG Ã— Canvas å®Œæ•´è³‡æ–™æµ                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                   â”‚
â”‚   â‘  User åœˆé¸å€åŸŸ + å•å•é¡Œ                                                         â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚
â”‚   â”‚   Canvas UI            â”‚   ç”¨æˆ¶ç”¨ freehand/bbox åœˆä¸€å¡Šå€åŸŸ                       â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”        â”‚   è¼¸å…¥: "é€™è£¡æ˜¯ä»€éº¼ï¼Ÿ"                                  â”‚
â”‚   â”‚   â”‚    â”‚â–“â–“â–“â–“  â”‚        â”‚                                                      â”‚
â”‚   â”‚   â”‚    â”‚â–“â–“â–“â–“  â”‚        â”‚                                                      â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜        â”‚                                                      â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚
â”‚                â”‚ user_region_select                                               â”‚
â”‚                â–¼                                                                  â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ â‘¡ MCP Tool Call: analyze_selected_region                                   â”‚  â”‚
â”‚   â”‚ {                                                                          â”‚  â”‚
â”‚   â”‚   session_id: "abc123",                                                    â”‚  â”‚
â”‚   â”‚   region: {type: "freehand", points: [[100,150], [120,180], ...]},         â”‚  â”‚
â”‚   â”‚   question: "é€™è£¡æ˜¯ä»€éº¼ï¼Ÿ",                                                 â”‚  â”‚
â”‚   â”‚   actions: ["describe", "rag_search", "classify"]  â† è§¸ç™¼ä¸‰ç¨®åˆ†æ           â”‚  â”‚
â”‚   â”‚ }                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ â‘¢ MCP Server å…§éƒ¨è™•ç†æµç¨‹                                                   â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚  â”‚
â”‚   â”‚   â”‚ Region Cropper  â”‚ ä¾æ“š region åº§æ¨™å¾åŸå½±åƒæ“·å–å­å€åŸŸ                      â”‚  â”‚
â”‚   â”‚   â”‚                 â”‚ è¼¸å‡º: cropped_image (224x224 æ¨™æº–åŒ–)                   â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚  â”‚
â”‚   â”‚            â”‚                                                               â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚  â”‚
â”‚   â”‚   â”‚  RAD-DINO       â”‚  â”‚  FAISS Index     â”‚  â”‚  Reference Database        â”‚â”‚  â”‚
â”‚   â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€       â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€     â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€        â”‚â”‚  â”‚
â”‚   â”‚   â”‚  Encode Image   â”‚â”€â–ºâ”‚  Search Top-K    â”‚â”€â–ºâ”‚  case_id â†’ Report         â”‚â”‚  â”‚
â”‚   â”‚   â”‚  â†’ [768-dim]    â”‚  â”‚  (L2 distance)   â”‚  â”‚  case_id â†’ Diagnosis      â”‚â”‚  â”‚
â”‚   â”‚   â”‚  ~2ç§’/å¼µ (GPU)  â”‚  â”‚  <1ms            â”‚  â”‚  case_id â†’ Annotations    â”‚â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚  â”‚
â”‚   â”‚            â”‚                                                               â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”                                                      â”‚  â”‚
â”‚   â”‚   â”‚  DenseNet-121   â”‚ å¿«é€Ÿåˆ†é¡ 18 ç¨® CXR ç—…ç†                                â”‚  â”‚
â”‚   â”‚   â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚ è¼¸å‡º: {infiltration: 0.85, nodule: 0.32, ...}        â”‚  â”‚
â”‚   â”‚   â”‚  ~0.1ç§’ (GPU)   â”‚                                                      â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                                      â”‚  â”‚
â”‚   â”‚            â”‚                                                               â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚   â”‚   â”‚ RAG Context Builder                                                  â”‚ â”‚  â”‚
â”‚   â”‚   â”‚ åˆä½µ: classification + similar_cases + region_metadata               â”‚ â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚                                          â”‚
â”‚                                        â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ â‘£ MCP Response (è¿”å›çµ¦å¤–éƒ¨ Agent)                                          â”‚  â”‚
â”‚   â”‚ {                                                                          â”‚  â”‚
â”‚   â”‚   region_info: {                                                           â”‚  â”‚
â”‚   â”‚     bounding_box: [100, 150, 220, 280],                                    â”‚  â”‚
â”‚   â”‚     pixel_stats: {mean: 128.5, std: 42.3},                                 â”‚  â”‚
â”‚   â”‚     anatomical_region: "right_lower_lung"                                  â”‚  â”‚
â”‚   â”‚   },                                                                       â”‚  â”‚
â”‚   â”‚   classification: {                                                        â”‚  â”‚
â”‚   â”‚     infiltration: 0.85,                                                    â”‚  â”‚
â”‚   â”‚     nodule: 0.32,                                                          â”‚  â”‚
â”‚   â”‚     consolidation: 0.28,                                                   â”‚  â”‚
â”‚   â”‚     ...                                                                    â”‚  â”‚
â”‚   â”‚   },                                                                       â”‚  â”‚
â”‚   â”‚   similar_cases: [                                                         â”‚  â”‚
â”‚   â”‚     {                                                                      â”‚  â”‚
â”‚   â”‚       case_id: "mimic-p10032546",                                          â”‚  â”‚
â”‚   â”‚       similarity: 0.95,                                                    â”‚  â”‚
â”‚   â”‚       report: "Findings: Right lower lobe infiltrate...",                  â”‚  â”‚
â”‚   â”‚       diagnosis: "Community-acquired pneumonia"                            â”‚  â”‚
â”‚   â”‚     },                                                                     â”‚  â”‚
â”‚   â”‚     {                                                                      â”‚  â”‚
â”‚   â”‚       case_id: "eurorad-case-4521",                                        â”‚  â”‚
â”‚   â”‚       similarity: 0.89,                                                    â”‚  â”‚
â”‚   â”‚       report: "Bilateral ground glass opacities...",                       â”‚  â”‚
â”‚   â”‚       diagnosis: "Viral pneumonia"                                         â”‚  â”‚
â”‚   â”‚     }                                                                      â”‚  â”‚
â”‚   â”‚   ],                                                                       â”‚  â”‚
â”‚   â”‚   confidence_summary: "é«˜æ©Ÿç‡è‚ºéƒ¨æµ¸æ½¤ (DenseNet: 85%, RAG Top-1: 95%)"       â”‚  â”‚
â”‚   â”‚ }                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚                                          â”‚
â”‚                                        â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ â‘¤ External Agent (Claude/GPT) ç¶œåˆåˆ¤æ–·                                      â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â”‚   è¼¸å…¥: MCP Response + ç”¨æˆ¶å•é¡Œ "é€™è£¡æ˜¯ä»€éº¼ï¼Ÿ"                               â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â”‚   Agent æ¨ç†:                                                              â”‚  â”‚
â”‚   â”‚   - DenseNet åˆ†é¡ infiltration = 0.85 (é«˜)                                 â”‚  â”‚
â”‚   â”‚   - RAG ç›¸ä¼¼æ¡ˆä¾‹ #1: pneumonia (similarity 0.95)                           â”‚  â”‚
â”‚   â”‚   - RAG ç›¸ä¼¼æ¡ˆä¾‹ #2: viral pneumonia (similarity 0.89)                     â”‚  â”‚
â”‚   â”‚   - å€åŸŸä½ç½®: right_lower_lung                                             â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â”‚   ç”Ÿæˆå›ç­”: "é€™å€‹å€åŸŸä½æ–¼å³ä¸‹è‚ºé‡ï¼Œå‘ˆç¾æ˜é¡¯çš„æµ¸æ½¤é™°å½±ã€‚                        â”‚  â”‚
â”‚   â”‚   æ ¹æ“šå½±åƒç‰¹å¾µå’Œç›¸ä¼¼æ¡ˆä¾‹åˆ†æï¼Œé«˜åº¦æ‡·ç–‘ç‚ºè‚ºç‚ã€‚                                â”‚  â”‚
â”‚   â”‚   å»ºè­°çµåˆè‡¨åºŠç—‡ç‹€é€²ä¸€æ­¥ç¢ºèª..."                                              â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â”‚   æ±ºå®šæ¨™è¨˜: éœ€è¦åœ¨ Canvas ä¸Šæ¨™ç¤ºç™¼ç¾å€åŸŸ                                      â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚                                          â”‚
â”‚                                        â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ â‘¥ push_to_canvas (Agent æ¨é€æ¨™è¨˜)                                          â”‚  â”‚
â”‚   â”‚ {                                                                          â”‚  â”‚
â”‚   â”‚   session_id: "abc123",                                                    â”‚  â”‚
â”‚   â”‚   action: "add_annotations",                                               â”‚  â”‚
â”‚   â”‚   payload: {                                                               â”‚  â”‚
â”‚   â”‚     annotations: [                                                         â”‚  â”‚
â”‚   â”‚       {                                                                    â”‚  â”‚
â”‚   â”‚         id: "agent-finding-001",                                           â”‚  â”‚
â”‚   â”‚         type: "bbox",                                                      â”‚  â”‚
â”‚   â”‚         source: "agent",                                                   â”‚  â”‚
â”‚   â”‚         coordinates: [100, 150, 220, 280],                                 â”‚  â”‚
â”‚   â”‚         label: "è‚ºéƒ¨æµ¸æ½¤",                                                  â”‚  â”‚
â”‚   â”‚         description: "å³ä¸‹è‚ºé‡æµ¸æ½¤æ€§é™°å½±ï¼Œç–‘ä¼¼è‚ºç‚",                          â”‚  â”‚
â”‚   â”‚         confidence: 0.85,                                                  â”‚  â”‚
â”‚   â”‚         style: {color: "#FF6B6B", opacity: 0.8, strokeWidth: 2}            â”‚  â”‚
â”‚   â”‚       }                                                                    â”‚  â”‚
â”‚   â”‚     ],                                                                     â”‚  â”‚
â”‚   â”‚     message: "é€™å€‹å€åŸŸä½æ–¼å³ä¸‹è‚ºé‡ï¼Œå‘ˆç¾æ˜é¡¯çš„æµ¸æ½¤é™°å½±...",                    â”‚  â”‚
â”‚   â”‚     related_suggestions: [                                                 â”‚  â”‚
â”‚   â”‚       {                                                                    â”‚  â”‚
â”‚   â”‚         region: {type: "bbox", coordinates: [50, 100, 150, 200]},          â”‚  â”‚
â”‚   â”‚         note: "ç›¸ä¼¼æ¡ˆä¾‹ä¸­æ­¤å€åŸŸä¹Ÿå¸¸æœ‰ç—…è®Šï¼Œå»ºè­°ä¸€ä½µæª¢æŸ¥",                      â”‚  â”‚
â”‚   â”‚         style: {color: "#FFE66D", lineDash: [5, 5]}                        â”‚  â”‚
â”‚   â”‚       }                                                                    â”‚  â”‚
â”‚   â”‚     ]                                                                      â”‚  â”‚
â”‚   â”‚   }                                                                        â”‚  â”‚
â”‚   â”‚ }                                                                          â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                        â”‚                                          â”‚
â”‚                                        â–¼                                          â”‚
â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚   â”‚ â‘¦ Canvas UI æ›´æ–°                                                           â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â”‚   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”             â”‚  â”‚
â”‚   â”‚   â”‚ Canvas é¡¯ç¤º                    â”‚   â”‚ å°è©±æ¡†              â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚                    â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ â”‚    â”‚â–“â–“â–“â–“  â”‚â† Agent æ¨™è¨˜      â”‚   â”‚ Agent: é€™å€‹å€åŸŸ    â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ â”‚    â”‚â–“â–“â–“â–“  â”‚  (ç´…è‰²å¯¦ç·š)      â”‚   â”‚ ä½æ–¼å³ä¸‹è‚ºé‡...    â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ â”‚ â”Œâ”€â”€â”      â”‚â† å»ºè­°å€åŸŸ        â”‚   â”‚                    â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ â”‚ â”‚  â”‚      â”‚  (é»ƒè‰²è™›ç·š)      â”‚   â”‚ User: OK, é‚£é€™é‚Šï¼Ÿ â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ â”‚ â””â”€â”€â”˜      â”‚                  â”‚   â”‚                    â”‚             â”‚  â”‚
â”‚   â”‚   â”‚ â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”˜                  â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜             â”‚  â”‚
â”‚   â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                       â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â”‚   å¾ªç’°ç¹¼çºŒ: User å¯ä»¥ç¹¼çºŒåœˆé¸ â†’ è§¸ç™¼æ–°çš„ RAG æŸ¥è©¢...                         â”‚  â”‚
â”‚   â”‚                                                                            â”‚  â”‚
â”‚   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### I.10.2 å„æ¨¡çµ„è²¬ä»»åŠƒåˆ†

| æ¨¡çµ„ | è²¬ä»» | è¼¸å…¥ | è¼¸å‡º |
|:-----|:-----|:-----|:-----|
| **Canvas UI** | ç”¨æˆ¶äº’å‹•ä»‹é¢ | ç”¨æˆ¶ç¹ªåœ–/å•é¡Œ | region + question |
| **MCP Server** | å°è£ AI æ¨¡å‹ | region + question | RAG context |
| **RAD-DINO** | å½±åƒç·¨ç¢¼ | cropped_image | 768-dim embedding |
| **FAISS** | å‘é‡æª¢ç´¢ | query_embedding | top-k similar |
| **DenseNet** | å¿«é€Ÿåˆ†é¡ | image | 18 ç—…ç†æ©Ÿç‡ |
| **Reference DB** | å„²å­˜æ¡ˆä¾‹ | case_id | report + diagnosis |
| **External Agent** | ç¶œåˆåˆ¤æ–·+ç”Ÿæˆ | RAG context | å›ç­” + æ¨™è¨˜æŒ‡ä»¤ |

#### I.10.3 MCP Server å…§éƒ¨å¯¦ä½œæ¶æ§‹

\`\`\`python
# src/medvision_mcp/tools/visual_rag.py

from dataclasses import dataclass
from typing import List, Optional
import torch
import faiss
import numpy as np

@dataclass
class RAGResult:
    case_id: str
    similarity: float
    report: str
    diagnosis: Optional[str]
    annotations: Optional[List[dict]]

class VisualRAGEngine:
    """Visual RAG æ ¸å¿ƒå¼•æ“"""
    
    def __init__(
        self,
        encoder_model: str = "microsoft/rad-dino",
        index_path: str = "data/faiss_index.bin",
        db_path: str = "data/reference_cases.db"
    ):
        # è¼‰å…¥ RAD-DINO ç·¨ç¢¼å™¨
        self.encoder = AutoModel.from_pretrained(encoder_model)
        self.processor = AutoImageProcessor.from_pretrained(encoder_model)
        
        # è¼‰å…¥ FAISS ç´¢å¼•
        self.index = faiss.read_index(index_path)
        
        # é€£æ¥åƒè€ƒè³‡æ–™åº«
        self.db = ReferenceDatabase(db_path)
    
    def encode_region(self, image: np.ndarray, region: dict) -> np.ndarray:
        """æ“·å–ä¸¦ç·¨ç¢¼å€åŸŸ"""
        # 1. Crop region from image
        cropped = self._crop_region(image, region)
        
        # 2. Preprocess
        inputs = self.processor(images=cropped, return_tensors="pt")
        
        # 3. Encode
        with torch.no_grad():
            outputs = self.encoder(**inputs)
            embedding = outputs.last_hidden_state[:, 0]  # CLS token
        
        return embedding.numpy()
    
    def search_similar(
        self,
        embedding: np.ndarray,
        top_k: int = 5
    ) -> List[RAGResult]:
        """æœå°‹ç›¸ä¼¼æ¡ˆä¾‹"""
        # FAISS æœå°‹
        distances, indices = self.index.search(embedding, top_k)
        
        # å¾è³‡æ–™åº«å–å¾—è©³ç´°è³‡è¨Š
        results = []
        for i, idx in enumerate(indices[0]):
            case = self.db.get_case(idx)
            results.append(RAGResult(
                case_id=case.id,
                similarity=1.0 / (1.0 + distances[0][i]),
                report=case.report,
                diagnosis=case.diagnosis,
                annotations=case.annotations
            ))
        
        return results


# MCP Tool å¯¦ä½œ
@mcp_tool()
async def analyze_selected_region(
    session_id: str,
    region: dict,
    question: str,
    actions: List[str] = ["describe", "rag_search", "classify"]
) -> dict:
    """
    åˆ†æç”¨æˆ¶åœ¨ Canvas ä¸Šé¸å–çš„å€åŸŸã€‚
    
    Args:
        session_id: æœƒè©± ID
        region: å€åŸŸå®šç¾© (type, coordinates/points)
        question: ç”¨æˆ¶å•é¡Œ
        actions: è¦åŸ·è¡Œçš„å‹•ä½œåˆ—è¡¨
            - "describe": æè¿°å€åŸŸåŸºæœ¬è³‡è¨Š
            - "rag_search": åŸ·è¡Œ Visual RAG æœå°‹
            - "classify": åŸ·è¡Œ DenseNet åˆ†é¡
    
    Returns:
        åŒ…å« region_info, classification, similar_cases çš„å­—å…¸
    """
    session = await get_session(session_id)
    image = session.current_image
    
    result = {}
    
    # 1. å€åŸŸåŸºæœ¬è³‡è¨Š
    if "describe" in actions:
        result["region_info"] = describe_region(image, region)
    
    # 2. Visual RAG æœå°‹
    if "rag_search" in actions:
        embedding = rag_engine.encode_region(image, region)
        similar = rag_engine.search_similar(embedding, top_k=5)
        result["similar_cases"] = [
            {
                "case_id": s.case_id,
                "similarity": s.similarity,
                "report": s.report,
                "diagnosis": s.diagnosis
            }
            for s in similar
        ]
    
    # 3. DenseNet åˆ†é¡
    if "classify" in actions:
        cropped = crop_region(image, region)
        result["classification"] = densenet_classify(cropped)
    
    # 4. çµ„åˆä¿¡å¿ƒåº¦æ‘˜è¦
    result["confidence_summary"] = build_confidence_summary(result)
    
    return result
\`\`\`

#### I.10.4 Canvas UI æ•´åˆ (React Hook)

\`\`\`typescript
// @medvision-mcp/canvas/src/hooks/useVisualRAG.ts

import { useMCP } from './useMCP';
import { useCanvas } from './useCanvas';
import { Annotation, Region } from '../types';

interface RAGSearchResult {
  region_info: {
    bounding_box: [number, number, number, number];
    pixel_stats: { mean: number; std: number };
    anatomical_region: string;
  };
  classification: Record<string, number>;
  similar_cases: Array<{
    case_id: string;
    similarity: number;
    report: string;
    diagnosis?: string;
  }>;
  confidence_summary: string;
}

export function useVisualRAG() {
  const { callTool } = useMCP();
  const { sessionId, addAnnotations, showMessage } = useCanvas();

  /**
   * ç”¨æˆ¶åœˆé¸å€åŸŸå¾Œè§¸ç™¼ Visual RAG åˆ†æ
   */
  const analyzeRegion = async (
    region: Region,
    question: string
  ): Promise<void> => {
    // 1. å‘¼å« MCP Tool
    const result = await callTool<RAGSearchResult>('analyze_selected_region', {
      session_id: sessionId,
      region,
      question,
      actions: ['describe', 'rag_search', 'classify'],
    });

    // 2. é¡¯ç¤ºè™•ç†ä¸­ç‹€æ…‹
    showMessage({
      type: 'processing',
      text: 'æ­£åœ¨åˆ†æé¸å–å€åŸŸ...',
    });

    // 3. çµæœæœƒç”± External Agent é€é push_to_canvas æ¨é€
  };

  /**
   * æ¥æ”¶ Agent æ¨é€çš„æ¨™è¨˜
   */
  const handleAgentPush = (payload: {
    annotations: Annotation[];
    message: string;
    related_suggestions?: Array<{
      region: Region;
      note: string;
    }>;
  }) => {
    // 1. æ·»åŠ  Agent æ¨™è¨˜
    addAnnotations(payload.annotations);

    // 2. é¡¯ç¤º Agent è¨Šæ¯
    showMessage({
      type: 'agent',
      text: payload.message,
    });

    // 3. é¡¯ç¤ºå»ºè­°å€åŸŸ (è™›ç·š)
    if (payload.related_suggestions) {
      const suggestions = payload.related_suggestions.map((s, idx) => ({
        id: \`suggestion-\${idx}\`,
        type: 'bbox' as const,
        source: 'agent' as const,
        coordinates: s.region.coordinates,
        label: s.note,
        style: {
          color: '#FFE66D',
          lineDash: [5, 5],
          opacity: 0.6,
        },
      }));
      addAnnotations(suggestions);
    }
  };

  return {
    analyzeRegion,
    handleAgentPush,
  };
}
\`\`\`

#### I.10.5 æ™‚åºåœ–

\`\`\`
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  User    â”‚     â”‚  Canvas  â”‚     â”‚   MCP    â”‚     â”‚ External â”‚     â”‚  Canvas  â”‚
â”‚          â”‚     â”‚    UI    â”‚     â”‚  Server  â”‚     â”‚  Agent   â”‚     â”‚   UI     â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ Draw region    â”‚                â”‚                â”‚                â”‚
     â”‚ + "é€™è£¡å‘¢ï¼Ÿ"   â”‚                â”‚                â”‚                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ analyze_selected_region         â”‚                â”‚
     â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â” Crop       â”‚                â”‚
     â”‚                â”‚                â”‚   â”‚ Encode     â”‚                â”‚
     â”‚                â”‚                â”‚   â”‚ Search     â”‚                â”‚
     â”‚                â”‚                â”‚   â”‚ Classify   â”‚                â”‚
     â”‚                â”‚                â”‚â—„â”€â”€â”˜            â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚   RAG Context  â”‚                â”‚                â”‚
     â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚  Forward to External Agent      â”‚
     â”‚                â”‚                â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚â”€â”€â”€â” LLM        â”‚
     â”‚                â”‚                â”‚                â”‚   â”‚ Reasoning  â”‚
     â”‚                â”‚                â”‚                â”‚â—„â”€â”€â”˜            â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚ push_to_canvas â”‚                â”‚
     â”‚                â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚ Add annotations + message       â”‚                â”‚
     â”‚                â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
     â”‚ See result     â”‚                â”‚                â”‚                â”‚
     â”‚â—„â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚                â”‚                â”‚                â”‚
     â”‚                â”‚                â”‚                â”‚                â”‚
\`\`\`

#### I.10.6 é…ç½®é¸é …

\`\`\`yaml
# config/visual_rag.yaml

visual_rag:
  # ç·¨ç¢¼å™¨è¨­å®š
  encoder:
    model: "microsoft/rad-dino"
    device: "cuda"  # or "cpu"
    batch_size: 4
  
  # FAISS ç´¢å¼•è¨­å®š
  index:
    path: "data/faiss_index.bin"
    dimension: 768
    metric: "L2"  # or "IP" (inner product)
  
  # æª¢ç´¢è¨­å®š
  retrieval:
    top_k: 5
    min_similarity: 0.5  # éæ¿¾ä½ç›¸ä¼¼åº¦çµæœ
    rerank: false  # æ˜¯å¦ä½¿ç”¨ reranker
  
  # åˆ†é¡å™¨è¨­å®š
  classifier:
    model: "densenet121-res224-chex"
    threshold: 0.5  # ç—…ç†é™½æ€§é–¾å€¼
  
  # åƒè€ƒè³‡æ–™åº«
  reference_db:
    type: "sqlite"
    path: "data/reference_cases.db"
    sources:
      - name: "MIMIC-CXR"
        path: "/data/mimic-cxr/"
        reports: true
        labels: true
      - name: "CheXpert"
        path: "/data/chexpert/"
        reports: false
        labels: true
      - name: "EURORAD"
        path: "data/eurorad_metadata.json"
        reports: true
        labels: true

# Canvas æ•´åˆè¨­å®š
canvas_integration:
  region_analysis:
    actions:
      - "describe"
      - "rag_search"
      - "classify"
    auto_suggest: true
    max_suggestions: 3
  
  annotation_styles:
    agent_finding:
      color: "#FF6B6B"
      opacity: 0.8
      strokeWidth: 2
    agent_suggestion:
      color: "#FFE66D"
      opacity: 0.6
      lineDash: [5, 5]
    user_selection:
      color: "#4ECDC4"
      opacity: 0.7
\`\`\`

#### I.10.7 Reference Database Schema

\`\`\`sql
-- data/reference_cases.db

CREATE TABLE cases (
    id INTEGER PRIMARY KEY,
    case_id TEXT UNIQUE NOT NULL,
    source TEXT NOT NULL,  -- 'MIMIC-CXR', 'CheXpert', 'EURORAD'
    image_path TEXT,
    embedding BLOB,  -- 768-dim float32 (3072 bytes)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE TABLE reports (
    id INTEGER PRIMARY KEY,
    case_id TEXT REFERENCES cases(case_id),
    section TEXT,  -- 'findings', 'impression', 'full'
    text TEXT NOT NULL
);

CREATE TABLE diagnoses (
    id INTEGER PRIMARY KEY,
    case_id TEXT REFERENCES cases(case_id),
    diagnosis TEXT NOT NULL,
    confidence REAL
);

CREATE TABLE labels (
    id INTEGER PRIMARY KEY,
    case_id TEXT REFERENCES cases(case_id),
    pathology TEXT NOT NULL,  -- 'infiltration', 'nodule', etc.
    value INTEGER  -- -1: uncertain, 0: negative, 1: positive
);

CREATE INDEX idx_cases_source ON cases(source);
CREATE INDEX idx_labels_pathology ON labels(pathology);
\`\`\`

---
